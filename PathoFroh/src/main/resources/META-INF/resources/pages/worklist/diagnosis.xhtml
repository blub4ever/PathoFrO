<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core">

    <h:outputScript library="scripts" name="closeOverlayPanelOnReturn.js"/>

    <ui:include src="include/navigationBar.xhtml"/>

    <script type="text/javascript">
        // disables the autofocus for the caseHistoryOverlayplpanel
        (function () {
            var proxied = PrimeFaces.widget.OverlayPanel.prototype.applyFocus;
            PrimeFaces.widget.OverlayPanel.prototype.applyFocus = function () {
                if (this.jq.hasClass("histoOverlayPanel")) {
                    return;
                }
                return proxied.apply(this, arguments);
            };
        })();
    </script>

    <p:panel style="width: 80%"
             styleClass="defaultHistoHiddenTableContainer">

        <h:outputLabel value="#{msg['body.diagnosis.headline']}"
                       style="font-size:1.5em;"/>

        <h:panelGrid columns="3" style="margin-top:10px;"
                     styleClass="defaultHistoHiddenTableContainer"
                     columnClasses="columnTop, , columnTop">

            <!-- Left Column -->
            <h:panelGrid columns="1" styleClass="defaultHistoTable">

                <h:panelGrid columns="1"
                             styleClass="defaultHistoHiddenTableContainer">

                    <!-- material -->
                    <c:forEach items="#{diagnosisView.task.samples}"
                               var="sample" varStatus="loopCount">

                        <h:panelGrid columns="2" styleClass="defaultHistoTable"
                                     columnClasses="columnWidth75,">

                            <h:outputLabel
                                    value="#{msg['body.diagnosis.sample']} #{sample.sampleID}"/>

                            <h:panelGroup>
                                <!-- Material Name -->
                                <p:inputText value="#{sample.material}"
                                             id="materialInput#{loopCount.index}"
                                             disabled="#{!diagnosisView.task.taskStatus.editable}"
                                             tabindex="1" styleClass="customBackground"
                                             onclick="commonFunctions.showAndUpdateOverlayPanel('materialOverlayPanel#{loopCount.index}', '#{component.clientId}' ,null, 'materialOverlayPanelDataTable#{loopCount.index}', 0, submitUpdateMaterial#{loopCount.index});"
                                             style="width:200px;float:right;background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}">

                                    <p:ajax event="change" execute="@this"
                                            listener="#{diagnosisView.save(sample.task, 'log.sample.edit.material',sample,sample.material)}"/>
                                </p:inputText>

                                <!-- material overlay panel -->
                                <p:overlayPanel id="materialOverlayPanel#{loopCount.index}"
                                                widgetVar="materialOverlayPanel#{loopCount.index}"
                                                styleClass="histoOverlayPanel" hideEffect="fade"
                                                style="width:500px" hideEvent="mousedown" showEvent="none"
                                                onkeypress="return false;">
                                    <p:dataTable filterDelay="50"
                                                 id="materialOverlayPanelDataTable#{loopCount.index}"
                                                 widgetVar="materialOverlayPanelDataTable#{loopCount.index}"
                                                 value="#{genericViewData.materialList}"
                                                 var="preset" styleClass="defaultHistoDataTable"
                                                 scrollable="true" scrollHeight="200" rowKey="#{preset.id}"
                                                 selection="#{diagnosisView.selectedMaterialPresets[loopCount.index]}"
                                                 selectionMode="single">

                                        <p:column filterBy="#{preset.name}" filterMatchMode="contains"
                                                  filterValue="#{diagnosisView.selectedMaterialPresetFilter[loopCount.index]}"
                                                  id="presetName">
                                            <h:outputText value="#{preset.name}"/>
                                        </p:column>

                                        <p:ajax event="rowSelect"
                                                process="contentForm:materialOverlayPanel#{loopCount.index}"
                                                partialSubmit="true"
                                                update="contentForm:materialInput#{loopCount.index}"
                                                listener="#{diagnosisView.updateMaterialOfSample(sample, diagnosisView.selectedMaterialPresets[loopCount.index],diagnosisView.selectedMaterialPresets[loopCount.index].name,'log.patient.task.sample.material.update',sample, diagnosisView.selectedMaterialPresets[loopCount.index].name)}"
                                                oncomplete="PF('materialOverlayPanel#{loopCount.index}').hide();"/>
                                    </p:dataTable>
                                </p:overlayPanel>

                                <p:remoteCommand name="submitUpdateMaterial#{loopCount.index}"
                                                 partialSubmit="true"
                                                 update="navigationForm:patientList contentForm:contentPanel headerForm"
                                                 actionListener="#{diagnosisView.updateMaterialOfSample(sample, null, diagnosisView.selectedMaterialPresetFilter[loopCount.index],'log.patient.task.sample.material.update',sample, diagnosisView.selectedMaterialPresetFilter[loopCount.index])}"
                                                 oncomplete="PF('materialOverlayPanel#{loopCount.index}').hide();"/>

                            </h:panelGroup>
                        </h:panelGrid>
                    </c:forEach>
                </h:panelGrid>
                <!-- material -->

                <!-- Eye -->
                <h:panelGrid columns="2" styleClass="defaultHistoTable">
                    <h:outputLabel value="#{msg['body.diagnosis.eye']}"/>
                    <p:selectOneMenu styleClass="customBackground" tabindex="6"
                                     style="background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}"
                                     disabled="#{!diagnosisView.task.taskStatus.editable}"
                                     value="#{diagnosisView.task.eye}">

                        <f:selectItems value="#{enumProvider.eyes}" var="eye"
                                       itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}"/>

                        <p:ajax event="change" execute="@this"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.eye',diagnosisView.task.eye)}"/>
                    </p:selectOneMenu>

                </h:panelGrid>
                <!-- Eye -->

                <!-- history -->
                <h:panelGrid columns="1" styleClass="defaultHistoTable">
                    <h:outputLabel value="#{msg['body.diagnosis.story']}"/>

                    <h:panelGroup>
                        <p:inputTextarea styleClass="customBackground"
                                         value="#{diagnosisView.task.caseHistory}"
                                         title="#{msg['body.diagnosis.story.watermark']}"
                                         disabled="#{!diagnosisView.task.taskStatus.editable}"
                                         id="caseHistoryInput" style="width:90%"
                                         onclick="commonFunctions.showAndUpdateOverlayPanel('caseHistoryOverlayPanel', '#{component.clientId}' ,null, 'caseHistoryOverlayPanelDataTable', 0,submitNewCustomCaseHistory);"
                                         onkeypress="PF('caseHistoryOverlayPanel').hide();">
                            <p:ajax event="change"
                                    listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.caseHistory',diagnosisView.task.caseHistory)}"/>
                        </p:inputTextarea>

                        <p:overlayPanel id="caseHistoryOverlayPanel"
                                        styleClass="histoOverlayPanel"
                                        widgetVar="caseHistoryOverlayPanel" hideEffect="fade"
                                        style="width:500px" hideEvent="mousedown" showEvent="none"
                                        onkeypress="return false;">
                            <p:dataTable id="caseHistoryOverlayPanelDataTable"
                                         widgetVar="caseHistoryOverlayPanelDataTable" filterDelay="50"
                                         value="#{genericViewData.caseHistoryList}"
                                         var="item" styleClass="defaultHistoDataTable" scrollable="true"
                                         scrollHeight="200" rowKey="#{item.id}"
                                         selection="#{diagnosisView.selectedCaseHistoryItem}"
                                         selectionMode="single">

                                <p:column filterBy="#{item.value}" filterMatchMode="contains"
                                          filterValue="#{diagnosisView.caseHistoryFilter}"
                                          id="valueColumn">
                                    <h:outputText value="#{item.value}"/>
                                </p:column>

                                <p:ajax event="rowSelect" update="contentForm:caseHistoryInput"
                                        process="contentForm:caseHistoryOverlayPanel"
                                        partialSubmit="true"
                                        listener="#{diagnosisView.updateCaseHistoryWithName(diagnosisView.task, diagnosisView.selectedCaseHistoryItem.value,'log.task.edit.caseHistory',diagnosisView.selectedCaseHistoryItem.value)}"
                                        oncomplete="PF('caseHistoryOverlayPanel').hide();"/>
                            </p:dataTable>
                        </p:overlayPanel>

                        <p:remoteCommand name="submitNewCustomCaseHistory"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         actionListener="#{diagnosisView.updateCaseHistoryWithName(diagnosisView.task, diagnosisView.caseHistoryFilter,'log.task.edit.caseHistory',diagnosisView.caseHistoryFilter)}"
                                         oncomplete="PF('caseHistoryOverlayPanel').hide();"/>

                    </h:panelGroup>
                </h:panelGrid>
            </h:panelGrid>
            <!-- Left Column -->

            <h:panelGroup>
                <h:outputLabel value="" style="margin-left:40px"/>
            </h:panelGroup>

            <!-- Right Column -->
            <h:panelGrid columns="1" styleClass="defaultHistoTable">

                <h:panelGrid columns="2" styleClass="defaultHistoTable">

                    <!-- Task Number -->
                    <h:outputLabel value="#{msg['body.diagnosis.taskNumber']}"/>
                    <h:panelGrid columns="2"
                                 styleClass="listingHistoHiddenTableContainer">
                        <p:inputText disabled="true"
                                     value="#{diagnosisView.task.taskID}"/>
                        <p:commandLink title="#{msg['body.diagnosis.taskNumber.change']}"
                                       rendered="#{userService.userHasPermission('TASK_EDIT_ID')}"
                                       disabled="#{!diagnosisView.task.taskStatus.editable}"
                                       actionListener="#{dialog.changeTaskIDDialog.initAndPrepareBean(worklistHandler.current.selectedTask)}">
                            <i class="fa fa-fw fa-cog"/>
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                    </h:panelGrid>

                    <!-- date of surgery -->
                    <h:outputLabel value="#{msg['body.diagnosis.surgeryDate']}"/>
                    <p:calendar pattern="dd.MM.yyyy" mask="true" tabindex="2" converter="localDateConverter"
                                style="background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}"
                                styleClass="customBackground"
                                disabled="#{!diagnosisView.task.taskStatus.editable}"
                                value="#{diagnosisView.task.dateOfSugery}">
                        <p:ajax event="dateSelect"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.dateOfSurgerye',diagnosisView.task.dateOfSugery)}"/>
                        <f:ajax event="change" execute="@this"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.dateOfSurgerye',diagnosisView.task.dateOfSugery)}"/>
                    </p:calendar>

                    <!-- date of receipt -->
                    <h:outputLabel value="#{msg['body.diagnosis.taskEDate']}"/>
                    <p:calendar pattern="dd.MM.yyyy" mask="true" tabindex="3" converter="localDateConverter"
                                disabled="#{!diagnosisView.task.taskStatus.editable}"
                                style="background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}"
                                styleClass="customBackground"
                                value="#{diagnosisView.task.receiptDate}">
                        <p:ajax event="dateSelect"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.receiptDate',diagnosisView.task.receiptDate)}"/>
                        <f:ajax event="change" execute="@this"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.receiptDate',diagnosisView.task.receiptDate)}"/>
                    </p:calendar>

                    <!-- insurance -->
                    <h:outputLabel value="#{msg['body.diagnosis.insurance']}"/>
                    <p:inputText
                            disabled="#{!diagnosisView.task.taskStatus.editable}"
                            value="#{diagnosisView.task.insurance}">
                        <p:ajax event="change" execute="@this"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.insurance',diagnosisView.task.insurance)}"/>
                    </p:inputText>

                    <!-- ward -->
                    <h:outputLabel value="#{msg['body.diagnosis.ward']}"/>
                    <p:selectOneMenu id="wards"
                                     value="#{diagnosisView.task.ward}"
                                     editable="true"
                                     disabled="#{!diagnosisView.task.taskStatus.editable}"
                                     styleClass="customBackground" tabindex="5"
                                     style="background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}">

                        <f:selectItems
                                value="#{genericViewData.wardList}"
                                itemValue="#{ward.value}" itemLabel="#{ward.value}" var="ward"/>
                        <p:ajax event="change" execute="@this"
                                listener="#{diagnosisView.save(diagnosisView.task, 'log.task.edit.ward',diagnosisView.task.ward)}"/>
                    </p:selectOneMenu>

                    <!-- surgeon -->
                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel value="#{msg['body.diagnosis.surgeon']}"/>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel style="margin-left:10px;"
                                       value="#{diagnosisView.task.getPrimaryContact('SURGEON', 'EXTERNAL_SURGEON').person.fullName}"/>

                        <h:panelGroup>
                            <p:commandLink style="float: right; margin-right:5px;"
                                           tabindex="9"
                                           onclick="commonFunctions.showAndUpdateOverlayPanel('surgeonPhysicianOverlayPanel', '#{component.clientId}' , null, 'surgeonPhysicianOverlayPanelDataTable', 0 ,null);"
                                           title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
                                           disabled="#{!diagnosisView.task.taskStatus.editable}">
                                <i class="fa fa-fw fa-scissors"/>
                            </p:commandLink>

                            <!-- surgeon overlay panel -->
                            <p:overlayPanel id="surgeonPhysicianOverlayPanel"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="surgeonPhysicianOverlayPanel" hideEffect="fade"
                                            style="width:500px" hideEvent="mousedown" showEvent="none"
                                            onkeypress="return false;">

                                <p:dataTable id="surgeonPhysicianOverlayPanelDataTable"
                                             widgetVar="surgeonPhysicianOverlayPanelDataTable"
                                             disabledSelection="#{physicianSelector.contactOfTask}"
                                             selection="#{diagnosisView.selectedSurgeon}"
                                             selectionMode="single"
                                             value="#{genericViewData.surgeons}"
                                             var="physicianSelector" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200"
                                             rowKey="#{physicianSelector.id}" rowIndexVar="rowId">

                                    <!-- name -->
                                    <p:column id="nameColumn" style="width:auto"
                                              filterValue="#{diagnosisView.selectedSurgeonFilter}"
                                              filterBy="#{physicianSelector.physician.person.getFullName()}"
                                              filterMatchMode="contains">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.person.getFullName()}"/>
                                    </p:column>

                                    <!-- role -->
                                    <p:column style="width: 30%">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.clinicRole}"/>
                                    </p:column>

                                    <!-- already selected -->
                                    <p:column style="width:5%; text-align:center;">
                                        <f:facet name="header">
                                            <i class="fa fa-check-square-o"
                                            />
                                        </f:facet>

                                        <ui:fragment rendered="#{physicianSelector.contactOfTask}">
                                            <i class="fa fa-check icon-green"
                                            />
                                        </ui:fragment>

                                    </p:column>

                                    <p:ajax event="rowSelect"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            process="contentForm:surgeonPhysicianOverlayPanelDataTable"
                                            partialSubmit=""
                                            listener="#{diagnosisView.addReportIntentToTask(diagnosisView.selectedSurgeon.physician.person, 'SURGEON')}"
                                            oncomplete="PF('surgeonPhysicianOverlayPanel').hide();"/>

                                </p:dataTable>
                            </p:overlayPanel>
                        </h:panelGroup>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel value="#{msg['body.diagnosis.privatePhysician']}"/>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel style="margin-left:10px;"
                                       value="#{diagnosisView.task.getPrimaryContact('PRIVATE_PHYSICIAN').person.fullName}"/>

                        <h:panelGroup>
                            <p:commandLink style="float: right; margin-right:5px;"
                                           tabindex="9"
                                           onclick="commonFunctions.showAndUpdateOverlayPanel('privatePhysicianPhysicianOverlayPanel', '#{component.clientId}' , null, 'privatePhysicianPhysicianOverlayPanelDataTable', 0 ,null);"
                                           title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
                                           disabled="#{!diagnosisView.task.taskStatus.editable}">
                                <i class="fa fa-fw fa-eye"/>
                            </p:commandLink>

                            <!-- private physician overlay panel -->
                            <p:overlayPanel id="privatePhysicianPhysicianOverlayPanel"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="privatePhysicianPhysicianOverlayPanel"
                                            hideEffect="fade" style="width:500px" hideEvent="mousedown"
                                            showEvent="none" onkeypress="return false;">

                                <p:dataTable id="privatePhysicianPhysicianOverlayPanelDataTable"
                                             widgetVar="privatePhysicianPhysicianOverlayPanelDataTable"
                                             disabledSelection="#{physicianSelector.contactOfTask}"
                                             selection="#{diagnosisView.selectedPrivatePhysician}"
                                             selectionMode="single"
                                             value="#{genericViewData.privatePhysicians}"
                                             var="physicianSelector" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200"
                                             rowKey="#{physicianSelector.id}" rowIndexVar="rowId">

                                    <!-- name -->
                                    <p:column style="width:auto"
                                              filterValue="#{diagnosisView.selectedPrivatePhysicianFilter}"
                                              filterBy="#{physicianSelector.physician.person.getFullName()}"
                                              filterMatchMode="contains">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.person.getFullName()}"/>
                                    </p:column>

                                    <!-- role -->
                                    <p:column style="width: 30%">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.clinicRole}"/>
                                    </p:column>

                                    <!-- already selected -->
                                    <p:column style="width:5%; text-align:center;">
                                        <f:facet name="header">
                                            <i class="fa fa-check-square-o"/>
                                        </f:facet>

                                        <ui:fragment rendered="#{physicianSelector.contactOfTask}">
                                            <i class="fa fa-check icon-green"/>
                                        </ui:fragment>

                                    </p:column>


                                    <p:ajax event="rowSelect"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            process="contentForm:privatePhysicianPhysicianOverlayPanel"
                                            partialSubmit="true"
                                            listener="#{diagnosisView.addReportIntentToTask(diagnosisView.selectedPrivatePhysician.physician.person, 'PRIVATE_PHYSICIAN')}"
                                            oncomplete="PF('privatePhysicianPhysicianOverlayPanel').hide();"/>

                                </p:dataTable>
                            </p:overlayPanel>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:panelGrid>
            </h:panelGrid>
            <!-- Right Column -->

        </h:panelGrid>

        <!-- Diagnoses -->
        <c:forEach
                items="#{diagnosisView.task.diagnosisRevisions}"
                varStatus="varCounterOuter" var="revision">

            <p:separator/>

            <!-- spot light -->
            <p:spotlight target="diagnosisSpotContent#{varCounterOuter.index}"
                         widgetVar="diagnosisSpotBlocker#{varCounterOuter.index}"/>

            <h:panelGrid id="diagnosisSpotContent#{varCounterOuter.index}"
                         styleClass="defaultHistoHiddenTableContainer" style="width:100%">

                <h:panelGrid columns="2" styleClass="defaultHistoTable"
                             id="diagnosisSpotDiagnosis#{varCounterOuter.index}"
                             columnClasses="columnWidth200 columnTop #{varCounterOuter.even ? '' : 'oddColumnColored' }, #{varCounterOuter.even ? '' : 'oddColumnColored'}">

                    <!-- Extended Diagnosis Text -->
                    <!-- diagonsis name-->
                    <h:panelGroup layout="block" id="pPannel"
                                  style="width: 90%; min-height:16px; #{revision.name == '' ? 'background: #fcf1b8' : ''}"
                                  onclick="PF('diagnosisNamePannel#{varCounterOuter.index}').show()">
                        <h:outputLabel value="#{revision.name}"/>

                        <p:overlayPanel id="diagnosisNamePannel#{varCounterOuter.index}"
                                        onHide="saveDiagnosisNameChange()" styleClass="histoOverlayPanel"
                                        widgetVar="diagnosisNamePannel#{varCounterOuter.index}"
                                        hideEffect="fade" hideEvent="none" showEvent="none">
                            <p:inputText id="nameInputPannelInput#{varCounterOuter.index}"
                                         onkeypress="return closeOverlayPanelOnReturn(event, 'diagnosisNamePannel#{varCounterOuter.index}')"
                                         disabled="#{!diagnosisView.task.taskStatus.editable}"
                                         value="#{revision.name}"/>
                        </p:overlayPanel>

                        <p:remoteCommand
                                actionListener="#{diagnosisView.save(revision.task, 'log.diagnosisRevision.edit.name',revision,revision.name)}"
                                name="saveDiagnosisNameChange"
                                update="navigationForm:patientList contentForm:contentPanel headerForm"/>

                    </h:panelGroup>

                    <!-- extende text input -->
                    <h:panelGroup id="extendedTextParent">
                        <p:inputTextarea style="width:99%" id="extendedText" rows="15"
                                         onfocus="disabledEventPropagation(event);"
                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                         value="#{revision.text}">
                            <p:ajax event="keyup" process="@this" delay="1000"
                                    listener="#{diagnosisView.save(revision.task, 'log.diagnosisRevision.edit.histologicalRecord',revision,revision.text)}"/>
                        </p:inputTextarea>
                    </h:panelGroup>

                    <!-- Diagnosis for sample -->
                    <c:forEach items="#{revision.diagnoses}"
                               varStatus="varCounterInner" var="diagnosis">

                        <c:choose>
                            <c:when test="#{varCounterInner.first}">
                                <h:outputLabel value="#{msg['body.diagnosis.diagnoses']}"/>
                            </c:when>
                            <c:otherwise>
                                <h:outputLabel value=""/>
                            </c:otherwise>
                        </c:choose>

                        <h:panelGroup>
                            <!-- sample -->
                            <c:choose>
                                <c:when test="#{revision.diagnoses.size() ne 1}">
                                    <h:outputLabel
                                            value="#{msg['body.diagnosis.sample']} #{diagnosis.sample.sampleID}"/>
                                </c:when>
                                <c:otherwise>
                                    <h:outputLabel value=""/>
                                </c:otherwise>
                            </c:choose>
                            <h:panelGroup>
                                <!-- copy diagnosis text -->
                                <p:commandLink style="margin-left:20px;"
                                               disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision) or diagnosis.diagnosisPrototype.extendedDiagnosisText eq ''}"
                                               title="#{diagnosis.diagnosisPrototype.extendedDiagnosisText eq '' ? msg['body.diagnosis.histologicalRecordPreset.text.none'] : msg['body.diagnosis.histologicalRecordPreset.text']}"
                                               rendered="#{diagnosis.diagnosisPrototype ne null}"
                                               process="@this"
                                               actionListener="#{diagnosisView.setSelectedDiagnosis(diagnosis)}"
                                               oncomplete="copyHistologicalRecordCommand()">
                                    <i class="fa fa-copy"/>
                                </p:commandLink>
                                <!-- commandlink will set the selected diagnosis, this will call the function -->
                                <p:remoteCommand
                                        actionListener="#{diagnosisView.copyHistologicalRecord(diagnosisView.selectedDiagnosis)}"
                                        update="contentForm:contentPanel" name="copyHistologicalRecordCommand"/>
                            </h:panelGroup>
                            <!-- malign -->
                            <h:panelGrid columns="2" style="float:right;margin-right:20px;">
                                <h:outputLabel value="#{msg['body.diagnosis.malign']}"/>
                                <p:selectBooleanCheckbox value="#{diagnosis.malign}"
                                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                                         style="margin:3px 0px 0px 3px;">
                                    <f:ajax event="change"
                                            listener="#{diagnosisView.save(diagnosis.task, 'log.diagnosis.edit.malign',diagnosis,diagnosis.malign)}"/>
                                </p:selectBooleanCheckbox>
                            </h:panelGrid>
                        </h:panelGroup>

                        <h:outputLabel/>
                        <h:panelGroup>
                            <!-- diagnosis text -->
                            <p:inputTextarea value="#{diagnosis.diagnosis}"
                                             onkeypress="PF('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}').hide();"
                                             onclick="commonFunctions.showAndUpdateOverlayPanel('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}', '#{component.clientId}' , null, 'diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}', 'contentForm:diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}:diagnosisColumn:filter',submitNewCustomDiagnosis#{varCounterOuter.index}#{varCounterInner.index});"
                                             filterDelay="50"
                                             id="diagnosisText#{varCounterOuter.index}#{varCounterInner.index}"
                                             disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                             style="width:99%">
                                <p:watermark
                                        for="diagnosisText#{varCounterOuter.index}#{varCounterInner.index}"
                                        value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.watermark']}"/>
                                <f:ajax event="change" execute="@this"
                                        listener="#{diagnosisView.save(diagnosis.task, 'log.diagnosis.edit.diagnosisText',diagnosis,diagnosis.diagnosis)}"/>
                            </p:inputTextarea>

                            <p:overlayPanel
                                    widgetVar="diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                    id="diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                    styleClass="histoOverlayPanel" hideEffect="fade"
                                    style="width:500px" hideEvent="mousedown" showEvent="none">

                                <p:dataTable
                                        id="diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}"
                                        widgetVar="diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}"
                                        value="#{genericViewData.diagnosisPresets}"
                                        var="item" styleClass="defaultHistoDataTable" scrollable="true"
                                        scrollHeight="200" rowKey="#{item.id}"
                                        selection="#{diagnosisView.selectedDiagnosisPresets[varCounterOuter.index][varCounterInner.index]}"
                                        selectionMode="single">

                                    <p:column filterBy="#{item.diagnosis}" id="diagnosisColumn"
                                              filterValue="#{diagnosisView.diagnosisFilter[varCounterOuter.index][varCounterInner.index]}"
                                              filterMatchMode="contains">
                                        <h:outputText value="#{item.diagnosis}"/>
                                    </p:column>

                                    <p:ajax event="rowSelect"
                                            process="contentForm:diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                            partialSubmit="true"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            listener="#{diagnosisView.updateDiagnosisPrototype(diagnosis,diagnosisView.selectedDiagnosisPresets[varCounterOuter.index][varCounterInner.index])}"
                                            oncomplete="PF('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}').hide();"/>

                                </p:dataTable>

                                <p:remoteCommand partialSubmit="true"
                                                 process="contentForm:diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                                 name="submitNewCustomDiagnosis#{varCounterOuter.index}#{varCounterInner.index}"
                                                 update="navigationForm:patientList contentForm:contentPanel headerForm"
                                                 actionListener="#{diagnosisView.updateDiagnosisPrototype(diagnosis,diagnosisView.diagnosisFilter[varCounterOuter.index][varCounterInner.index])}"
                                                 oncomplete="PF('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}').hide();"/>

                            </p:overlayPanel>
                        </h:panelGroup>
                        <!-- Diagnosis for sample -->
                    </c:forEach>

                </h:panelGrid>
                <!-- ****************************** Signature ****************************** -->
                <h:panelGrid columns="6" styleClass="defaultHistoTable"
                             id="diagnosisSpotContentSignature#{varCounterOuter.index}"
                             columnClasses="columnLabelContainer200 columnTop #{varCounterOuter.even ? '' : 'oddColumnColored' }, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}">

                    <h:outputLabel value="#{msg['body.diagnosis.signature.date']}"/>
                    <p:calendar pattern="dd.MM.yyyy" mask="true" converter="localDateConverter"
                                disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                value="#{revision.signatureDate}">
                        <p:ajax event="dateSelect"
                                listener="#{diagnosisView.save(revision.task, 'log.diagnosisRevision.edit.signautreDate',revision,revision.signatureDate)}"/>
                        <f:ajax event="change" execute="@this"
                                listener="#{diagnosisView.save(revision.task, 'log.diagnosisRevision.edit.signautreDate',revision,revision.signatureDate)}"/>
                    </p:calendar>

                    <!-- physician -->
                    <h:outputLabel value="#{msg['body.diagnosis.signature.physician']}"/>
                    <h:panelGroup>
                        <p:selectOneMenu
                                disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                style="width:90% !important;"
                                panelStyleClass="iconFixForSelectOneMenu"
                                value="#{revision.signatureOne.physician}"
                                converter="#{genericViewData.physiciansToSignListTransformer}"
                                filter="true" filterMatchMode="contains">

                            <f:selectItem
                                    itemLabel="#{msg['body.diagnosis.signature.physician.select']}"
                                    itemValue="#{null}"/>

                            <f:selectItems
                                    value="#{genericViewData.physiciansToSignList}"
                                    var="physician" itemLabel="#{physician.person.getFullName()}"
                                    itemValue="#{physician}"/>

                            <p:ajax event="change"
                                    onstart="PF('submitPhysicianChange').jq.click()"/>

                        </p:selectOneMenu>

                        <!-- on consultant change -->
                        <p:commandButton style="display: none"
                                         actionListener="#{diagnosisView.updatePhysiciansSignature(revision.task,revision.signatureOne,'log.diagnosisRevision.edit.signatureOne.update', revision, revision.signatureOne.physician.person.getFullName(), revision.signatureOne.role)}"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         widgetVar="submitPhysicianChange"/>
                    </h:panelGroup>

                    <!-- Consultant -->
                    <h:outputLabel
                            value="#{msg['body.diagnosis.signature.consultant']}"/>
                    <h:panelGroup>
                        <p:selectOneMenu
                                disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                style="width:90% !important;"
                                panelStyleClass="iconFixForSelectOneMenu"
                                value="#{revision.signatureTwo.physician}"
                                converter="#{genericViewData.physiciansToSignListTransformer}"
                                filter="true" filterMatchMode="contains">
                            <f:selectItem
                                    itemLabel="#{msg['body.diagnosis.signature.consultant.select']}"
                                    itemValue="#{null}"/>

                            <f:selectItems
                                    value="#{genericViewData.physiciansToSignList}"
                                    var="physician" itemLabel="#{physician.person.getFullName()}"
                                    itemValue="#{physician}"/>

                            <p:ajax event="change"
                                    oncomplete="PF('submitConsultantChange').jq.click()"/>
                        </p:selectOneMenu>

                        <!-- on consultant change -->
                        <p:commandButton style="display: none"
                                         actionListener="#{diagnosisView.updatePhysiciansSignature(revision.task,revision.signatureTwo,'log.diagnosisRevision.edit.signatureTwo.update', revision, revision.signatureTwo.physician.person.getFullName(), revision.signatureTwo.role)}"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         widgetVar="submitConsultantChange"/>
                    </h:panelGroup>

                    <h:panelGroup/>
                    <h:panelGroup/>
                    <h:panelGroup/>

                    <!-- physician role -->
                    <h:panelGroup>
                        <p:selectOneMenu id="pysicianToSignRole" editable="true"
                                         style="width:90% !important;"
                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                         value="#{revision.signatureOne.role}">
                            <f:selectItems value="#{enumProvider.signatureRoles}"
                                           var="signatureRole"
                                           itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
                                           itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}"/>
                            <p:ajax event="change"
                                    onstart="PF('submitPhysicianRoleChange').jq.click()"/>
                        </p:selectOneMenu>

                        <!-- on physician role change -->
                        <p:commandButton style="display: none"
                                         actionListener="#{diagnosisView.save(revision.task,'log.diagnosisRevision.edit.signatureOne.role',revision, revision.signatureOne.role.toString())}"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         widgetVar="submitPhysicianRoleChange"/>
                    </h:panelGroup>

                    <h:panelGroup/>

                    <!-- Consultant role -->
                    <h:panelGroup>
                        <p:selectOneMenu id="consultantToSignRole" editable="true"
                                         style="width:90% !important"
                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                         value="#{revision.signatureTwo.role}">
                            <f:selectItems value="#{enumProvider.signatureRoles}"
                                           var="signatureRole"
                                           itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
                                           itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}"/>
                            <p:ajax event="change"
                                    oncomplete="PF('submitConsultantRoleChange').jq.click()"/>
                        </p:selectOneMenu>

                        <!-- on consultant role change -->
                        <p:commandButton style="display: none"
                                         actionListener="#{diagnosisView.save(revision.task,'log.diagnosisRevision.edit.signatureTwo.role',revision, revision.signatureTwo.role)}"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         widgetVar="submitConsultantRoleChange"/>
                    </h:panelGroup>
                </h:panelGrid>


                <!-- Buttons -->
                <h:panelGrid columns="3" styleClass="defaultHistoTable"
                             id="diagnosisSpotContentButtons#{varCounterOuter.index}"
                             columnClasses="columnWidthMin,columnWidthMin, columnWidthAuto">

                    <!-- new diagnosis revision -->
                    <p:commandButton widgetVar="newDiagnosisRevision#{varCounterOuter.index}"
                                     value="#{msg['body.diagnosis.diagnosis.new']}"
                                     icon="fa fa-plus-circle"
                                     actionListener="#{dialog.createDiagnosisRevisionDialog.initAndPrepareBean(diagnosisView.task)}">
                        <p:ajax event="dialogReturn"
                                listener="#{dialogReturnHandler.onDefaultReturn}"
                                update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                    </p:commandButton>

                    <h:panelGroup>
                        <!-- end or reend diagnosis-->
                        <p:splitButton
                                value="#{!revision.completed ? msg['body.diagnosis.diagnosis.end'] : msg['body.diagnosis.diagnosis.re_end']}"
                                rendered="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionInEditAmendmentMode(revision) }"
                                disabled="#{!diagnosisView.task.taskStatus.editable}"
                                onclick="$('#contentForm\\:endDiagnosisRevision#{varCounterOuter.index}').click();"
                                icon="fa fa-eye-slash">

                            <!-- amendment -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.amendment']}"
                                        rendered="#{revision.completed}"
                                        icon="fa fa-edit"
                                        onclick="$('#contentForm\\:admendDiagnosisRevision#{varCounterOuter.index}').click();"
                                        disabled="#{!diagnosisView.task.taskStatus.editable}"/>

                            <!-- rename -->
                            <p:menuitem
                                    value="#{msg['body.diagnosis.diagnosis.rename']}"
                                    onclick="PF('editDiagnosisRevision#{varCounterOuter.index}').jq.click();"
                                    icon="fa fa-pencil"
                                    disabled="#{!diagnosisView.task.taskStatus.editable}"/>


                            <!-- delete diagnosis -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.delete']}"
                                        icon="fa fa-trash"
                                        onclick="PF('deleteRevision#{varCounterOuter.index}').jq.click();"
                                        disabled="#{!diagnosisView.task.taskStatus.editable}"/>

                            <p:separator/>

                            <!-- new staining -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.slide']}"
                                        icon="fa fa-paint-brush"
                                        onclick="PF('newStaining').jq.click();"
                                        disabled="#{!diagnosisView.task.taskStatus.editable}"/>

                            <p:separator/>

                            <!-- print diagnosis -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.print']}"
                                        icon="fa fa-print" disabled="true"/>
                        </p:splitButton>

                        <!-- save changes -->
                        <p:commandButton value="#{msg['body.diagnosis.diagnosis.lock']}"
                                         rendered="#{worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionInEditAmendmentMode(revision) }"
                                         oncomplete="PF('diagnosisSpotBlocker#{varCounterOuter.index}').hide()"
                                         icon="fa fa-check-circle-o"
                                         update="diagnosisSpotDiagnosis#{varCounterOuter.index} diagnosisSpotContentSignature#{varCounterOuter.index} diagnosisSpotContentButtons#{varCounterOuter.index}">
                            <f:actionListener
                                    binding="#{diagnosisView.endDiagnosisAmendment(revision)}"/>
                        </p:commandButton>

                        <!-- edit diagnosis revision -->
                        <p:commandButton
                                widgetVar="editDiagnosisRevision#{varCounterOuter.index}"
                                style="display:none"
                                actionListener="#{dialog.editDiagnosisRevisionsDialog.initAndPrepareBean(worklistHandler.current.selectedTask,revision)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandButton>

                        <!-- delete diagnosis revision -->
                        <p:commandButton widgetVar="deleteRevision#{varCounterOuter.index}"
                                         style="display:none"
                                         actionListener="#{dialog.deleteDiagnosisRevisionDialog.initAndPrepareBean(revision)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandButton>

                        <!-- adment revision -->
                        <p:commandButton style="display:none"
                                         id="admendDiagnosisRevision#{varCounterOuter.index}"
                                         oncomplete="PF('diagnosisSpotBlocker#{varCounterOuter.index}').show()"
                                         update="diagnosisSpotDiagnosis#{varCounterOuter.index} diagnosisSpotContentSignature#{varCounterOuter.index} diagnosisSpotContentButtons#{varCounterOuter.index}">
                            <f:actionListener
                                    binding="#{diagnosisView.beginDiagnosisAmendment(revision)}"/>
                        </p:commandButton>

                        <!-- new staining -->
                        <p:commandButton style="display:none"
                                         id="newStaining" widgetVar="newStaining"
                                         actionListener="#{slideOverviewDialog.initAndPrepareBean(worklistHandler.current.selectedTask)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm headerForm"/>
                        </p:commandButton>

                        <!-- end diangosis -->
                        <p:commandButton id="endDiagnosisRevision#{varCounterOuter.index}"
                                         style="display:none"
                                         actionListener="#{diagnosisPhaseExitDialog.initAndPrepareBean(worklistHandler.current.selectedTask, revision)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandButton>

                    </h:panelGroup>

                    <!-- status icons -->
                    <h:panelGroup>
                        <h:panelGroup id="diagnosisCompleted#{varCounterOuter.index}">
                            <i class="fa fa-fw fa-rss-square fa-lg #{revision.completed ? 'icon-green' : 'icon-grey'}"
                               title=""/>
                            <p:tooltip for="diagnosisCompleted#{varCounterOuter.index}">
                                <h:outputLabel
                                        value="#{revision.completed ? msg['body.diagnosis.diagnosis.approved'] : msg['body.diagnosis.diagnosis.approved.not']} "/>
                                <h:outputText rendered="#{revision.completed}"
                                              value="#{revision.completionDate}">
                                    <f:converter converterId="instantDateTimeConverter"/>
                                    <f:attribute name="pattern" value="dd.MM.yyyy HH:mm"/>
                                </h:outputText>
                            </p:tooltip>
                        </h:panelGroup>

                        <!-- nofitication complete date -->
                        <h:panelGroup id="notificationsCompleted#{varCounterOuter.index}">
                            <h:panelGroup
                                    rendered="#{revision.notificationStatus != 'NO_NOTFICATION'}">
                                <i class="fa fa-fw fa-volume-up fa-lg #{revision.notified ? 'icon-green' : 'icon-grey'}"
                                   title=""/>
                                <p:tooltip for="notificationsCompleted#{varCounterOuter.index}">
                                    <h:outputLabel
                                            value="#{revision.notified ? msg['body.diagnosis.diagnosis.notification'] : msg['body.diagnosis.diagnosis.notification.not']} "/>
                                    <h:outputText rendered="#{revision.notified}"
                                                  value="#{revision.notificationDate}">
                                        <f:converter converterId="instantDateTimeConverter"/>
                                        <f:attribute name="pattern" value="dd.MM.yyyy HH:mm"/>
                                    </h:outputText>
                                </p:tooltip>
                            </h:panelGroup>

                            <!-- no notification necessary -->
                            <h:panelGroup
                                    rendered="#{revision.notificationStatus == 'NO_NOTFICATION'}">
                                <i class="fa fa-fw fa-stack-exchange fa-lg icon-orange"/>
                                <p:tooltip for="notificationsCompleted#{varCounterOuter.index}">
                                    <h:outputLabel value="Keine Benachrichtigung druchgeführt"/>
                                </p:tooltip>
                            </h:panelGroup>
                        </h:panelGroup>

                    </h:panelGroup>
                </h:panelGrid>

            </h:panelGrid>
        </c:forEach>
        <!-- commands -->
        <h:panelGroup>
            <!-- command to open the copy histological record dialog from bean-->
            <p:commandButton id="openDiagnosisRecordDialog" style="display: none"
                             actionListener="#{diagnosisRecordDialog.initAndPrepareBean(diagnosisView.selectedDiagnosis)}"
                             widgetVar="openDiagnosisRecordDialog">
                <p:ajax event="dialogReturn" listener="#{dialogReturnHandler.onDefaultReturn}"
                        update="contentForm:contentPanel"/>
            </p:commandButton>
        </h:panelGroup>
    </p:panel>

    <script type="application/javascript">

        function disabledEventPropagation(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            } else if (window.event) {
                window.event.cancelBubble = true;
            }
        }
    </script>

</ui:composition>

