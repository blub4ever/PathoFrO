<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core">

    <h:outputScript library="scripts" name="closeOverlayPanelOnReturn.js"/>
    <h:outputScript library="scripts" name="commonFunctions.js"/>

    <ui:include src="include/navigationBar.xhtml"/>

    <script type="text/javascript">
        // disables the autofocus for the caseHistoryOverlayplpanel
        (function () {
            var proxied = PrimeFaces.widget.OverlayPanel.prototype.applyFocus;
            PrimeFaces.widget.OverlayPanel.prototype.applyFocus = function () {
                if (this.jq.hasClass("histoOverlayPanel"))
                    return;
                return proxied.apply(this, arguments);
            };
        })();
    </script>

    <p:panel style="width: 80%"
             styleClass="defaultHistoHiddenTableContainer">

        <h:outputLabel
                value="#{msg['body.receiptlog.taskId']} #{receiptLogView.task.taskID}"
                style="font-size:1.5em;"/>

        <h:panelGrid columns="3" style="margin-top:10px; width:100%"
                     styleClass="defaultHistoHiddenTableContainer"
                     columnClasses="columnTop, columnTop, columnTop">

            <!-- Left Column -->
            <h:panelGrid columns="2" styleClass="defaultHistoTable">

                <!-- Receipt Date -->
                <h:outputLabel value="#{msg['body.receiptlog.taskEDate']}"/>
                <p:calendar pattern="dd.MM.yyyy" mask="true" id="receiptDate" converter="localDateConverter"
                            style="width: 80%;background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}"
                            styleClass="customBackground"
                            disabled="#{!receiptLogView.task.taskStatus.editable}"
                            value="#{receiptLogView.task.receiptDate}">
                    <p:ajax event="dateSelect"
                            listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.receiptDate',receiptLogView.task.receiptDate)}"
                            update="receiptDate"/>
                    <f:ajax event="change" execute="@this" render="receiptDate"
                            listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.receiptDate',receiptLogView.task.receiptDate)}"/>
                </p:calendar>

                <!-- Termin Date -->
                <h:outputLabel value="#{msg['body.receiptlog.taskDueDate']}"/>
                <h:panelGrid columns="2"
                             styleClass="listingHistoHiddenTableContainer">

                    <p:selectBooleanCheckbox style="padding-right:5px;"
                                             disabled="#{!receiptLogView.task.taskStatus.editable}"
                                             title="#{msg['body.receiptlog.taskDueDate.hint']}"
                                             value="#{receiptLogView.task.dueDateSelected}">
                        <p:ajax event="change" execute="@this"
                                update="navigationForm:patientList contentForm:contentPanel"
                                listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.dueDate.use',receiptLogView.task.dueDateSelected)}">
                        </p:ajax>

                    </p:selectBooleanCheckbox>

                    <p:calendar pattern="dd.MM.yyyy" mask="true" id="dueDate"
                                style="width: 80%;background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor};"
                                styleClass="customBackground" converter="localDateConverter"
                                value="#{receiptLogView.task.dueDate}"
                                disabled="#{!receiptLogView.task.dueDateSelected or !receiptLogView.task.taskStatus.editable}">
                        <p:ajax event="dateSelect"
                                listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.dueDate.date',receiptLogView.task.dueDate)}"
                                update="dueDate"/>
                        <f:ajax event="change" execute="@this" render="dueDate"
                                listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.dueDate.date',receiptLogView.task.dueDate)}"/>
                    </p:calendar>
                </h:panelGrid>

                <!-- ward -->
                <h:outputLabel value="#{msg['body.diagnosis.ward']}"/>
                <p:selectOneMenu id="wards"
                                 value="#{receiptLogView.task.ward}"
                                 style="width: 80%;background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor};"
                                 styleClass="customBackground" editable="true"
                                 disabled="#{!receiptLogView.task.taskStatus.editable}">
                    <f:selectItems
                            value="#{genericViewData.wardList}"
                            itemValue="#{ward.value}" itemLabel="#{ward.value}" var="ward"/>
                    <p:ajax event="change" execute="@this"
                            listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.ward',receiptLogView.task.ward)}"/>
                </p:selectOneMenu>


                <!-- EYE -->
                <h:outputLabel value="#{msg['body.receiptlog.eye']}"/>
                <p:selectOneMenu
                        style="width: 80%;background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor};"
                        styleClass="customBackground"
                        value="#{receiptLogView.task.eye}"
                        disabled="#{!receiptLogView.task.taskStatus.editable}">

                    <f:selectItems value="#{enumProvider.eyes}" var="eye"
                                   itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}"/>

                    <p:ajax event="change" execute="@this"
                            listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.eye',receiptLogView.task.eye)}"/>
                </p:selectOneMenu>

                <!-- History -->
                <h:outputLabel value="#{msg['body.receiptlog.story']}"/>
                <h:panelGroup>
                    <p:inputTextarea styleClass="customBackground"
                                     disabled="#{!receiptLogView.task.taskStatus.editable}"
                                     value="#{receiptLogView.task.caseHistory}"
                                     title="#{msg['body.diagnosis.story.watermark']}"
                                     id="caseHistoryInput" style="width:90%"
                                     onclick="commonFunctions.showAndUpdateOverlayPanel('caseHistoryOverlayPanel', '#{component.clientId}' ,null, 'caseHistoryOverlayPanelDataTable', 0,submitNewCustomCaseHistory);"
                                     onkeypress="PF('caseHistoryOverlayPanel').hide();">
                        <p:ajax event="change"
                                listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.caseHistory',receiptLogView.task.caseHistory)}"> </p:ajax>
                    </p:inputTextarea>

                    <p:overlayPanel id="caseHistoryOverlayPanel"
                                    styleClass="histoOverlayPanel" widgetVar="caseHistoryOverlayPanel"
                                    hideEffect="fade" style="width:500px" hideEvent="mousedown"
                                    showEvent="none" onkeypress="return false;">
                        <p:dataTable id="caseHistoryOverlayPanelDataTable"
                                     widgetVar="caseHistoryOverlayPanelDataTable" filterDelay="50"
                                     value="#{genericViewData.caseHistoryList}"
                                     var="item" styleClass="defaultHistoDataTable" scrollable="true"
                                     scrollHeight="200" rowKey="#{item.id}"
                                     selection="#{receiptLogView.selectedCaseHistoryItem}"
                                     selectionMode="single">

                            <p:column filterBy="#{item.value}" filterMatchMode="contains"
                                      filterValue="#{receiptLogView.caseHistoryFilter}"
                                      id="valueColumn">
                                <h:outputText value="#{item.value}"/>
                            </p:column>
                            <p:ajax event="rowSelect" update="contentForm:caseHistoryInput"
                                    process="contentForm:caseHistoryOverlayPanel"
                                    partialSubmit="true"
                                    listener="#{receiptLogView.updateCaseHistoryWithName(receiptLogView.task, receiptLogView.selectedCaseHistoryItem.value,'log.task.edit.caseHistory',receiptLogView.selectedCaseHistoryItem.value)}"
                                    oncomplete="PF('caseHistoryOverlayPanel').hide();"/>
                        </p:dataTable>
                    </p:overlayPanel>

                    <p:remoteCommand name="submitNewCustomCaseHistory"
                                     update="navigationForm:patientList contentForm:contentPanel headerForm"
                                     actionListener="#{receiptLogView.updateCaseHistoryWithName(receiptLogView.task, receiptLogView.caseHistoryFilter,'log.task.edit.caseHistory',receiptLogView.caseHistoryFilter)}"
                                     oncomplete="PF('caseHistoryOverlayPanel').hide();"/>
                </h:panelGroup>

                <!-- commentary -->
                <h:outputLabel value="#{msg['body.receiptlog.commentary']}"/>
                <p:inputTextarea styleClass="customBackground"
                                 disabled="#{!receiptLogView.task.taskStatus.editable}"
                                 value="#{receiptLogView.task.commentary}"
                                 style="width:90%">
                    <p:ajax event="change"
                            listener="#{receiptLogView.save(receiptLogView.task, 'log.task.edit.commentary',receiptLogView.task.commentary)}"/>
                </p:inputTextarea>

            </h:panelGrid>

            <!-- middle column -->
            <h:panelGrid columns="1" styleClass="defaultHistoTable">
                <h:panelGrid columns="2"
                             styleClass="listingHistoHiddenTableContainer">
                    <!-- material -->
                    <p:outputLabel value="#{msg['body.receiptlog.material']}"
                                   styleClass="bigFont"/>
                </h:panelGrid>

                <!-- material -->
                <c:forEach items="#{receiptLogView.task.samples}"
                           var="sample" varStatus="loopCount">

                    <h:panelGrid columns="2"
                                 styleClass="listingHistoHiddenTableContainer"
                                 columnClasses="column75px,">
                        <h:outputLabel
                                value="#{msg['body.diagnosis.sample']} #{sample.sampleID}"/>
                        <h:panelGroup>
                            <p:inputText value="#{sample.material}"
                                         id="materialInput#{loopCount.index}"
                                         disabled="#{!receiptLogView.task.taskStatus.editable}"
                                         tabindex="1" styleClass="customBackground"
                                         onclick="commonFunctions.showAndUpdateOverlayPanel('materialOverlayPanel#{loopCount.index}', '#{component.clientId}' ,null, 'materialOverlayPanelDataTable#{loopCount.index}', 0, submitUpdateMaterial#{loopCount.index});"
                                         style="width:200px;float:right;background:##{userService.currentUser.settings.inputFieldColor};color:##{userService.currentUser.settings.inputFieldFontColor}">

                                <p:ajax event="change" execute="@this"
                                        listener="#{receiptLogView.save(sample.task, 'log.sample.edit.material',sample,sample.material)}"/>
                            </p:inputText>

                            <p:overlayPanel id="materialOverlayPanel#{loopCount.index}"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="materialOverlayPanel#{loopCount.index}"
                                            hideEffect="fade" style="width:500px" hideEvent="mousedown"
                                            showEvent="none" onkeypress="return false;">
                                <p:dataTable filterDelay="50"
                                             id="materialOverlayPanelDataTable#{loopCount.index}"
                                             widgetVar="materialOverlayPanelDataTable#{loopCount.index}"
                                             value="#{genericViewData.materialList}"
                                             var="preset" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200" rowKey="#{preset.id}"
                                             selection="#{receiptLogView.selectedMaterialPresets[loopCount.index]}"
                                             selectionMode="single">

                                    <p:column filterBy="#{preset.name}" filterMatchMode="contains"
                                              filterValue="#{receiptLogView.selectedMaterialPresetFilter[loopCount.index]}"
                                              id="presetName">
                                        <h:outputText value="#{preset.name}"/>
                                    </p:column>

                                    <p:ajax event="rowSelect"
                                            process="contentForm:materialOverlayPanel#{loopCount.index}"
                                            partialSubmit="true"
                                            update="contentForm:materialInput#{loopCount.index}"
                                            listener="#{receiptLogView.updateMaterialOfSample(sample, receiptLogView.selectedMaterialPresets[loopCount.index],receiptLogView.selectedMaterialPresets[loopCount.index].name,'log.patient.task.sample.material.update',sample, receiptLogView.selectedMaterialPresets[loopCount.index].name)}"
                                            oncomplete="PF('materialOverlayPanel#{loopCount.index}').hide();"/>
                                </p:dataTable>

                            </p:overlayPanel>

                            <p:remoteCommand name="submitUpdateMaterial#{loopCount.index}"
                                             partialSubmit="true"
                                             update="navigationForm:patientList contentForm:contentPanel headerForm"
                                             actionListener="#{receiptLogView.updateMaterialOfSample(sample, null, receiptLogView.selectedMaterialPresetFilter[loopCount.index],'log.patient.task.sample.material.update',sample, receiptLogView.selectedMaterialPresetFilter[loopCount.index])}"
                                             oncomplete="PF('materialOverlayPanel#{loopCount.index}').hide();"/>
                        </h:panelGroup>
                    </h:panelGrid>
                </c:forEach>
            </h:panelGrid>

            <!-- right column -->
            <h:panelGrid columns="1" styleClass="defaultHistoTable">
                <h:panelGrid columns="2"
                             styleClass="defaultHistoHiddenTableContainer">
                    <!-- contact -->
                    <h:outputLabel value="#{msg['body.receiptlog.notification']}"
                                   styleClass="bigFont"/>

                    <h:panelGrid columns="3" style="margin-left:20px;"
                                 styleClass="listingHistoHiddenTableContainer">
                        <!-- quickContact surgeon -->
                        <h:panelGroup>
                            <p:commandLink
                                    onclick="commonFunctions.showAndUpdateOverlayPanel('surgeonPhysicianOverlayPanel', '#{component.clientId}' , null, 'surgeonPhysicianOverlayPanelDataTable', 0 ,null);"
                                    title="#{msg['body.receiptlog.notification.surgeon.hint']}"
                                    disabled="#{!receiptLogView.task.taskStatus.editable}">
                                <i class="fa fa-fw fa-scissors"/>
                            </p:commandLink>

                            <!-- surgeon overlay panel -->
                            <p:overlayPanel id="surgeonPhysicianOverlayPanel"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="surgeonPhysicianOverlayPanel" hideEffect="fade"
                                            style="width:500px" hideEvent="mousedown" showEvent="none"
                                            onkeypress="return false;">

                                <p:dataTable id="surgeonPhysicianOverlayPanelDataTable"
                                             widgetVar="surgeonPhysicianOverlayPanelDataTable"
                                             disabledSelection="#{physicianSelector.contactOfTask}"
                                             selection="#{receiptLogView.selectedSurgeon}"
                                             selectionMode="single"
                                             value="#{genericViewData.surgeons}"
                                             var="physicianSelector" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200"
                                             rowKey="#{physicianSelector.id}" rowIndexVar="rowId">

                                    <!-- name -->
                                    <p:column style="width:auto"
                                              filterValue="#{receiptLogView.selectedSurgeonFilter}"
                                              filterBy="#{physicianSelector.physician.person.getFullName()}"
                                              filterMatchMode="contains">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.person.getFullName()}"/>
                                    </p:column>

                                    <!-- role -->
                                    <p:column style="width: 30%">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.clinicRole}"/>
                                    </p:column>

                                    <!-- already selected -->
                                    <p:column style="width:5%; text-align:center;">
                                        <f:facet name="header">
                                            <i class="fa fa-check-square-o"
                                            />
                                        </f:facet>

                                        <ui:fragment rendered="#{physicianSelector.contactOfTask}">
                                            <i class="fa fa-check icon-green"
                                            />
                                        </ui:fragment>

                                    </p:column>


                                    <p:ajax event="rowSelect"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            process="contentForm:surgeonPhysicianOverlayPanelDataTable"
                                            partialSubmit=""
                                            listener="#{receiptLogView.addReportIntentToTask(receiptLogView.selectedSurgeon.physician.person, 'SURGEON')}"
                                            oncomplete="PF('surgeonPhysicianOverlayPanel#{loopCount.index}').hide();"/>

                                </p:dataTable>
                            </p:overlayPanel>
                        </h:panelGroup>


                        <!-- quickcontact private physician  -->
                        <h:panelGroup>
                            <p:commandLink
                                    onclick="commonFunctions.showAndUpdateOverlayPanel('privatePhysicianPhysicianOverlayPanel', '#{component.clientId}' , null, 'privatePhysicianPhysicianOverlayPanelDataTable', 0 ,null);"
                                    title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
                                    disabled="#{!receiptLogView.task.taskStatus.editable}">
                                <i class="fa fa-fw fa-eye"/>
                            </p:commandLink>

                            <!-- private physician overlay panel -->
                            <p:overlayPanel id="privatePhysicianPhysicianOverlayPanel"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="privatePhysicianPhysicianOverlayPanel"
                                            hideEffect="fade" style="width:500px" hideEvent="mousedown"
                                            showEvent="none" onkeypress="return false;">

                                <p:dataTable id="privatePhysicianPhysicianOverlayPanelDataTable"
                                             widgetVar="privatePhysicianPhysicianOverlayPanelDataTable"
                                             disabledSelection="#{physicianSelector.contactOfTask}"
                                             selection="#{receiptLogView.selectedPrivatePhysician}"
                                             selectionMode="single"
                                             value="#{genericViewData.privatePhysicians}"
                                             var="physicianSelector" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200"
                                             rowKey="#{physicianSelector.id}" rowIndexVar="rowId">

                                    <!-- name -->
                                    <p:column id="nameColumn" style="width:auto"
                                              filterValue="#{receiptLogView.selectedPrivatePhysicianFilter}"
                                              filterBy="#{physicianSelector.physician.person.getFullName()}"
                                              filterMatchMode="contains">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.person.getFullName()}"/>
                                    </p:column>

                                    <!-- role -->
                                    <p:column style="width: 30%">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.clinicRole}"/>
                                    </p:column>

                                    <!-- already selected -->
                                    <p:column style="width:5%; text-align:center;">
                                        <f:facet name="header">
                                            <i class="fa fa-check-square-o"
                                            />
                                        </f:facet>

                                        <ui:fragment rendered="#{physicianSelector.contactOfTask}">
                                            <i class="fa fa-check icon-green"
                                            />
                                        </ui:fragment>

                                    </p:column>


                                    <p:ajax event="rowSelect"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            process="contentForm:privatePhysicianPhysicianOverlayPanel"
                                            partialSubmit="true"
                                            listener="#{receiptLogView.addReportIntentToTask(receiptLogView.selectedPrivatePhysician.physician.person, 'PRIVATE_PHYSICIAN')}"
                                            oncomplete="PF('privatePhysicianPhysicianOverlayPanel#{loopCount.index}').hide();"/>

                                </p:dataTable>
                            </p:overlayPanel>
                        </h:panelGroup>

                        <!-- edit contacts -->
                        <p:commandLink title="#{msg['body.receiptlog.notification.hint']}"
                                       disabled="#{!receiptLogView.task.taskStatus.editable}"
                                       actionListener="#{contactDialog.initAndPrepareBean(receiptLogView.task)}">
                            <i class="fa fa-fw fa-cog"/>
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel"/>
                        </p:commandLink>
                    </h:panelGrid>

                </h:panelGrid>
                <h:panelGroup>
                    <!-- contacts -->
                    <p:dataTable var="reportIntent" scrollable="true" scrollHeight="90"
                                 style="width:450px" styleClass="defaultHistoDataTable"
                                 value="#{receiptLogView.reportIntentStatus.reportIntentBearer}">

                        <!-- name -->
                        <p:column style="width:auto">
                            <f:facet name="header">
                                <h:outputLabel value="#{msg['body.receiptlog.contact.name']}"/>
                            </f:facet>

                            <h:outputLabel value="#{reportIntent.person.getFullName()}" id="test123"/>

                            <p:commandLink
                                    styleClass="contactInfoOverplayTrigger"
                                    icon="pi pi-search"
                                    actionListener="#{receiptLogView.setSelectedReportIntentStatus(reportIntent)}"
                                    partialSubmit="true"
                                    process="@this"
                                    update="contentForm:contactInfoOverlayPanel"
                                    oncomplete="commonFunctions.showOverlayPanel('contactInfoOverlayPanel', '#{component.clientId}');">
                                <i class="fa fa-info-circle"/>
                            </p:commandLink>
                        </p:column>

                        <!-- role-->
                        <p:column style="width: 20%;">
                            <f:facet name="header">
                                <h:outputLabel value="#{msg['body.receiptlog.contact.role']}"/>
                            </f:facet>
                            <h:outputLabel
                                    value="#{msg['enum.contactRole.'.concat(reportIntent.role)]}"
                                    title="#{msg['enum.contactRole.'.concat(reportIntent.role)]}">
                                <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                <f:attribute name="truncateAt" value="13"/>
                                <f:attribute name="continuationMark" value="..."/>
                            </h:outputLabel>
                        </p:column>

                        <!-- city -->
                        <p:column style="width: 20%;">
                            <f:facet name="header">
                                <h:outputLabel value="#{msg['body.receiptlog.contact.location']}"/>
                            </f:facet>

                            <h:outputLabel
                                    value="#{reportIntent.address.town}"
                                    title="#{reportIntent.address.town}">
                                <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                <f:attribute name="truncateAt" value="15"/>
                                <f:attribute name="continuationMark" value="..."/>
                            </h:outputLabel>
                        </p:column>

                        <!-- completed -->
                        <p:column style="width:15px">
                            <f:facet name="header">
                                <i class="fa fa-check-square-o"
                                   title="#{msg['body.receiptlog.contact.type.performed']}"/>
                            </f:facet>
                            <ui:fragment rendered="#{reportIntent.completed}">
                                <i class="fa fa-check icon-green"/>
                            </ui:fragment>
                        </p:column>
                    </p:dataTable>

                    <script type="text/javascript">
                        commonFunctions.addGlobalHideOverlayPanelOnMouseClickHandler('contactInfoOverlayPanel')
                        commonFunctions.addShowDialogOnMouseEnterForClickable(".contactInfoOverplayTrigger", "contactInfoOverlayPanel")
                    </script>

                    <!-- overlay for contact notifications -->
                    <p:overlayPanel widgetVar="contactInfoOverlayPanel" hideEvent="null" showEvent="null"
                                    dismissable="false" id="contactInfoOverlayPanel" styleClass="histoOverlayPanel">

                        <c:forEach items="#{receiptLogView.selectedReportIntentStatus.diagnosisBearers}"
                                   var="diagnosisBearer">

                            <h:panelGrid columns="1" style="width:400px !important;" styleClass="defaultHistoTable">

                                <h:panelGroup layout="block" style="widht:100%;" styleClass="histo_header">
                                    <h:outputText value="#{diagnosisBearer.diagnosisName}"/>
                                </h:panelGroup>

                                <c:forEach items="#{diagnosisBearer.reportIntentNotificationBearers}"
                                           var="notificationBearer">

                                    <h:panelGrid columns="5" styleClass="defaultHistoHiddenTableContainer"
                                                 style="width:98% !important;margin-left: 10px"
                                                 columnClasses="columnWidth25,columnWidth75,columnWidth75,columnWidth75,">

                                        <!-- type icon -->
                                        <h:panelGroup>
                                            <ui:fragment
                                                    rendered="#{notificationBearer.type eq 'EMAIL'}">
                                                <i class="fa fa-envelope icon-grey"/>
                                            </ui:fragment>

                                            <ui:fragment rendered="#{notificationBearer.type eq 'FAX'}">
                                                <i class="fa fa-fax icon-grey"/>
                                            </ui:fragment>

                                            <ui:fragment
                                                    rendered="#{notificationBearer.type eq 'LETTER'}">
                                                <i class="fa fa-pencil-square-o icon-grey"/>
                                            </ui:fragment>

                                            <ui:fragment
                                                    rendered="#{notificationBearer.type eq 'PHONE'}">
                                                <i class="fa fa-phone icon-grey"/>
                                            </ui:fragment>

                                            <ui:fragment
                                                    rendered="#{notificationBearer.type eq 'PRINT'}">
                                                <i class="fa fa-print icon-grey"/>
                                            </ui:fragment>
                                        </h:panelGroup>

                                        <!-- attempts -->
                                        <h:outputFormat value="#{msg['body.receiptlog.contact.overview.attempts']}">
                                            <f:param value="#{notificationBearer.attempts}"/>
                                        </h:outputFormat>

                                        <!-- successes -->
                                        <h:outputFormat value="#{msg['body.receiptlog.contact.overview.success']}">
                                            <f:param value="#{notificationBearer.successes}"/>
                                        </h:outputFormat>

                                        <!-- failedAttempts -->
                                        <h:outputFormat
                                                value="#{msg['body.receiptlog.contact.overview.failedAttampts']}">
                                            <f:param value="#{notificationBearer.failedAttempts}"/>
                                        </h:outputFormat>

                                        <!-- performed -->
                                        <ui:fragment rendered="#{notificationBearer.attempts != 0}">
                                            <h:panelGroup>
                                                <h:outputLabel
                                                        value="#{msg['body.receiptlog.contact.overview.performed']}"/>
                                                <i class="fa fa-fw #{notificationBearer.success ? 'fa-check-circle icon-green' :'fa-exclamation-triangle icon-red'}"
                                                   title="#{msg['body.statiningView.idManuallyAltered']}"/>
                                            </h:panelGroup>
                                        </ui:fragment>

                                        <ui:fragment rendered="#{notificationBearer.attempts == 0}">
                                            <h:panelGroup>
                                                <h:outputLabel
                                                        value="#{msg['body.receiptlog.contact.overview.performed']}"/>
                                                <i class="fa fa-fw fa-minus"/>
                                            </h:panelGroup>
                                        </ui:fragment>

                                    </h:panelGrid>

                                </c:forEach>
                            </h:panelGrid>
                        </c:forEach>
                    </p:overlayPanel>
                </h:panelGroup>
            </h:panelGrid>
        </h:panelGrid>

        <!-- slide list -->
        <h:panelGrid columns="1" styleClass="defaultHistoTable">
            <!-- healinse -->
            <h:panelGroup>
                <h:outputLabel value="#{msg['body.receiptlog.slide.name']}" styleClass="bigFont"/>
                <!-- staining completed -->
                <h:panelGroup
                        rendered="#{!receiptLogView.task.taskStatus.listStatus.inListStaining and !receiptLogView.task.taskStatus.listStatus.inListReStaining}">
                    <div class="fa fa-check-circle icon-green" title="#{msg['body.receiptlog.slide.completed']}"/>
                </h:panelGroup>
                <!-- staining to perform -->
                <h:panelGroup
                        rendered="#{receiptLogView.task.taskStatus.listStatus.inListStaining}">
                    <div class="fa fa-exclamation-circle icon-orange" title="#{msg['body.receiptlog.slide.staining']}"/>
                </h:panelGroup>
                <!-- restaining to perform -->
                <h:panelGroup
                        rendered="#{receiptLogView.task.taskStatus.listStatus.inListReStaining}">
                    <div class="fa fa-exclamation-circle ic-custom icon-orange"
                         title="#{msg['body.receiptlog.slide.restaining']}"/>
                </h:panelGroup>
            </h:panelGroup>

            <!-- data -->
            <p:dataTable var="stainingRow"
                         styleClass="noBackgroundHistoDataTable"
                         value="#{receiptLogView.rows}"
                         rowIndexVar="index">

                <!-- sample -->
                <p:column style="width: 12%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}"
                          headerText="#{msg['body.receiptlog.slide.headline.sample']}">

                    <h:panelGroup rendered="#{stainingRow.sampleType}">
                        <h:panelGroup layout="block" style="width: 90%; min-height:20px">
                            <p:commandLink process="@this" update="contentForm:contentPanel"
                                           styleClass="updateName_js_Class"
                                           oncomplete="commonFunctions.showAndUpdateOverlayPanel('idInputPannel', '#{component.clientId}' ,null, null, 'contentForm:idInputPannelInput', null);">

                                <h:outputLabel styleClass="doNotHideOverlay_js_Class"
                                               value="#{msg['body.receiptlog.slide.sample']} #{stainingRow.IDText}"/>

                                <h:panelGroup rendered="#{stainingRow.entity.idManuallyAltered}">
                                    <i class="fa fa-fw fa-chain doNotHideOverlay_js_Class"
                                       title="#{msg['body.statiningView.idManuallyAltered']}"/>
                                </h:panelGroup>

                                <!-- saving if overlay panel is already shown and something was changed -->
                                <f:ajax
                                        listener="#{receiptLogView.entityNameChange(receiptLogView.selectedRow, 'log.task.edit.idManuallyAltered', receiptLogView.selectedRow.entity.toString())}"/>

                                <!-- showing panel with new data -->
                                <f:ajax
                                        listener="#{receiptLogView.setSelectedRow(stainingRow)}"/>

                            </p:commandLink>
                        </h:panelGroup>
                    </h:panelGroup>

                </p:column>

                <!-- Block -->
                <p:column style="width: 12%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}"
                          headerText="#{msg['body.receiptlog.slide.headline.block']}">

                    <h:panelGroup rendered="#{stainingRow.blockType}">
                        <h:panelGroup layout="block" style="width: 90%; min-height:20px">
                            <p:commandLink process="@this" update="contentForm:contentPanel"
                                           styleClass="updateName_js_Class"
                                           oncomplete="commonFunctions.showAndUpdateOverlayPanel('idInputPannel', '#{component.clientId}' ,null, null, 'contentForm:idInputPannelInput', null);">
                                <h:outputLabel styleClass="doNotHideOverlay_js_Class"
                                               value="#{msg['body.receiptlog.slide.block']} #{stainingRow.IDText}"/>
                                <h:panelGroup rendered="#{stainingRow.entity.idManuallyAltered}">
                                    <i class="fa fa-fw fa-chain doNotHideOverlay_js_Class"
                                       title="#{msg['body.statiningView.idManuallyAltered']}"/>
                                </h:panelGroup>

                                <!-- saving if overlay panel is already shown and something was changed -->
                                <f:ajax
                                        listener="#{receiptLogView.entityNameChange(receiptLogView.selectedRow, 'log.task.edit.idManuallyAltered', receiptLogView.selectedRow.entity.toString())}"/>
                                <!-- showing panel with new data -->
                                <f:ajax
                                        listener="#{receiptLogView.setSelectedRow(stainingRow)}"/>
                            </p:commandLink>

                        </h:panelGroup>

                    </h:panelGroup>
                </p:column>

                <!-- Staining chooser -->
                <p:column style="width: 3%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}"
                          headerText="">

                    <h:panelGroup
                            rendered="#{stainingRow.sampleType or stainingRow.blockType}">
                        <p:commandLink
                                actionListener="#{receiptLogView.toggleSelectoin(stainingRow)}"
                                update="contentForm:contentPanel"
                                title="#{stainingRow.sampleType ? msg['body.statiningView.chooseSample'] : msg['body.statiningView.chooseBlock']}">
                            <i class="fa fa-fw fa-check-circle"/>
                        </p:commandLink>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{stainingRow.stainingType}">
                        <p:selectBooleanCheckbox value="#{stainingRow.selected}"/>
                    </h:panelGroup>

                </p:column>

                <!-- staining - name -->
                <p:column style="width: 19%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}"
                          headerText="#{msg['body.receiptlog.slide.headline.staining.id']}">

                    <h:panelGroup rendered="#{stainingRow.stainingType}">
                        <h:panelGroup layout="block" style="width: 90%; min-height:20px">

                            <p:commandLink process="@this" update="contentForm:contentPanel"
                                           styleClass="updateName_js_Class"
                                           oncomplete="commonFunctions.showAndUpdateOverlayPanel('idInputPannel', '#{component.clientId}' ,null, null, 'contentForm:idInputPannelInput', null);">

                                <h:outputLabel value="#{stainingRow.IDText}"
                                               styleClass="doNotHideOverlay_js_Class"/>

                                <h:panelGroup rendered="#{stainingRow.entity.idManuallyAltered}">
                                    <i class="fa fa-fw fa-chain doNotHideOverlay_js_Class"
                                       title="#{msg['body.statiningView.idManuallyAltered']}"/>
                                </h:panelGroup>

                                <!-- saving if overlay panel is already shown and something was changed -->
                                <f:ajax
                                        listener="#{receiptLogView.entityNameChange(receiptLogView.selectedRow, 'log.task.edit.idManuallyAltered', stainingRow.entity.toString())}"/>
                                <!-- showing panel with new data -->
                                <f:ajax
                                        listener="#{receiptLogView.setSelectedRow(stainingRow)}"/>
                            </p:commandLink>

                        </h:panelGroup>
                    </h:panelGroup>

                </p:column>

                <!-- staining slide text -->
                <p:column style="width: auto;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}"
                          headerText="#{msg['body.receiptlog.slide.headline.staining.slideLabelText']}">

                    <h:panelGroup rendered="#{stainingRow.stainingType}">

                        <p:selectOneMenu style="width: 90%"
                                         value="#{stainingRow.entity.slideLabelText}" editable="true"
                                         disabled="#{!receiptLogView.task.taskStatus.editable or stainingRow.entity.stainingCompleted}">

                            <f:selectItems
                                    value="#{genericViewData.slideCommentary}"
                                    var="slideLabelText" itemLabel="#{slideLabelText.value}"
                                    itemValue="#{slideLabelText.value}"/>

                            <p:ajax event="change" execute="@this"
                                    listener="#{receiptLogView.save(stainingRow.entity.task, 'log.slide.edit.textUpdate',stainingRow.entity, stainingRow.IDText)}"/>
                        </p:selectOneMenu>

                    </h:panelGroup>
                </p:column>

                <!-- commentary -->
                <p:column style="width: 4%"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''} centerChildElements"
                          headerText="#{msg['body.receiptlog.slide.headline.staining.commentary']}">
                    <h:panelGroup
                            rendered="#{stainingRow.stainingType and not empty stainingRow.entity.commentary}">
                        <i class="fa fa-fw fa-exclamation-triangle icon-red"
                           title="#{stainingRow.entity.commentary}"/>
                    </h:panelGroup>
                </p:column>

                <!-- Staining staining -->
                <p:column style="width: 8%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}"
                          headerText="#{msg['body.receiptlog.slide.headline.staining.staining']}">

                    <h:panelGroup rendered="#{stainingRow.stainingType}">
                        <h:outputText value="#{stainingRow.entity.slidePrototype.name}"/>
                    </h:panelGroup>

                </p:column>

                <!-- Staining status -->
                <p:column style="width: 5%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''} centerChildElements">

                    <!-- Sample status -->
                    <h:panelGroup rendered="#{stainingRow.sampleType}">
                        <!-- ********** Staining performed ********** -->
                        <h:panelGroup
                                rendered="#{receiptLogView.task.taskStatus.checkIfStainingCompleted(stainingRow.entity)}">
                            <i class="fa fa-fw fa-check-circle icon-green"
                               title="#{msg['body.statiningView.status.performed']}"/>
                        </h:panelGroup>
                    </h:panelGroup>

                    <!-- Block status -->
                    <h:panelGroup rendered="#{stainingRow.blockType}">
                        <!-- ********** Staining performed ********** -->
                        <h:panelGroup
                                rendered="#{receiptLogView.task.taskStatus.checkIfStainingCompleted(stainingRow.entity)}">
                            <i class="fa fa-fw fa-check-circle icon-green"
                               title="#{msg['body.statiningView.status.performed']}"/>
                        </h:panelGroup>
                    </h:panelGroup>

                    <!-- Slide status -->
                    <h:panelGroup rendered="#{stainingRow.stainingType}">
                        <!-- ********** Staining performed ********** -->
                        <h:panelGroup rendered="#{stainingRow.entity.stainingCompleted}">
                            <i class="fa fa-fw fa-check-circle icon-green"
                               title="#{msg['body.statiningView.status.performed']}"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{stainingRow.entity.reStaining}">
                            <i class="fa fa-fw fa-th-list icon-orange"
                               title="#{msg['body.statiningView.status.restaining']}"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </p:column>

                <!-- Options -->
                <p:column style="width: 11%;"
                          styleClass="#{stainingRow.even ? 'manual-column-color' : ''}">

                    <f:facet name="header">
                        <h:outputLabel
                                value="#{msg['body.receiptlog.slide.headline.options']}"/>
                        <p:commandLink id="quickTaskSettings"
                                       actionListener="#{dialog.slideNamingDialog.initAndPrepareBean(receiptLogView.task)}">
                            <i class="fa fa-wrench" style="float: right; margin-right: 5px"
                               title="#{msg['body.receiptlog.slide.headline.options.text']}"/>
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel"/>
                        </p:commandLink>
                    </f:facet>

                    <!-- Sample -->
                    <h:panelGroup rendered="#{stainingRow.sampleType}"
                                  style="float: right">
                        <!-- ********** New Block Button ********** -->
                        <p:commandLink title="#{msg['body.statiningView.newBlock']}"
                                       disabled="#{!receiptLogView.task.taskStatus.editable}"
                                       update="navigationForm:patientList contentForm:contentPanel headerForm"
                                       actionListener="#{receiptLogView.createNewBlock(stainingRow.entity)}">
                            <i class="fa fa-fw fa-stop"/>
                        </p:commandLink>
                        <!-- ********** Delete Button ********** -->
                        <p:commandLink title="#{msg['body.statiningView.archiveSample']}"
                                       disabled="#{!receiptLogView.task.taskStatus.editable}"
                                       actionListener="#{deleteTaskEntityDialog.initAndPrepareBean(stainingRow.entity).advancedHeader('dialog.delete.sample.text',stainingRow.entity.sampleID).advancedText('dialog.delete.sample.text',stainingRow.entity.sampleID)}">
                            <i class="fa fa-fw fa-times-circle"/>
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDeleteTaskEntityReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                    </h:panelGroup>

                    <!-- Block -->
                    <h:panelGroup rendered="#{stainingRow.blockType}"
                                  style="float: right">
                        <!-- ********** New slide Button ********** -->
                        <h:panelGroup>
                            <p:commandLink title="#{msg['body.statiningView.newStaining']}"
                                           disabled="#{!receiptLogView.task.taskStatus.editable}"
                                           actionListener="#{dialog.addSlidesDialog.initAndPrepareBean(stainingRow.entity)}">
                                <i class="fa fa-fw fa-paint-brush"/>
                                <p:ajax event="dialogReturn"
                                        update="navigationForm:patientList contentForm:contentPanel headerForm"
                                        listener="#{dialogReturnHandler.onStainingPhaseUpdateReturn}"
                                />
                            </p:commandLink>
                        </h:panelGroup>
                        <!-- ********** Delete Button ********** -->
                        <p:commandLink
                                disabled="#{!receiptLogView.task.taskStatus.editable}"
                                title="#{msg['body.statiningView.archiveBlock']}"
                                actionListener="#{deleteTaskEntityDialog.initAndPrepareBean(stainingRow.entity).advancedHeader('dialog.delete.block.headline',stainingRow.entity.blockID).advancedText('dialog.delete.block.text',stainingRow.entity.blockID)}">
                            <i class="fa fa-fw fa-times-circle"/>
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDeleteTaskEntityReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                    </h:panelGroup>

                    <!-- Staining -->
                    <h:panelGroup rendered="#{stainingRow.stainingType}"
                                  style="float: right">
                        <!-- ********** Print Button ********** -->
                        <p:commandLink
                                actionListener="#{receiptLogView.printLabels(stainingRow.entity)}"
                                title="#{msg['body.statiningView.printStaining']}">
                            <i class="fa fa-fw fa-print"/>
                            <p:ajax event="dialogReturn"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                        <!-- complete Button -->
                        <p:commandLink
                                actionListener="#{receiptLogView.completeSlide(stainingRow.entity,true)}"
                                title="#{msg['body.statiningView.stainingCompleted']}"
                                update="navigationForm:patientList contentForm:contentPanel headerForm">
                            <i class="fa fa-fw fa-check-circle"/>
                        </p:commandLink>
                        <!-- ********** Cloud Button ********** -->
                        <p:commandLink title="#{msg['body.statiningView.showStaining']}"
                                       disabled="true">
                            <i class="fa fa-fw fa-file-photo-o"/>
                            <p:ajax event="dialogReturn"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                        <!-- ********** Delete Button ********** -->
                        <p:commandLink
                                disabled="#{!receiptLogView.task.taskStatus.editable}"
                                title="#{msg['body.statiningView.archiveStaining']}"
                                actionListener="#{deleteTaskEntityDialog.initAndPrepareBean(stainingRow.entity).advancedHeader('dialog.delete.slide.headline',stainingRow.entity.slideID).advancedText('dialog.delete.slide.text',stainingRow.entity.slideID)}">
                            <i class="fa fa-fw fa-times-circle"/>
                            <p:ajax event="dialogReturn"
                                    oncomplete="updateAndAutoScrollToSelectedElement('contentForm:contentScrollPane')"
                                    listener="#{dialogReturnHandler.onDeleteTaskEntityReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                    </h:panelGroup>
                </p:column>
            </p:dataTable>

            <script type="text/javascript">
                commonFunctions.addGlobalHideOverlayPanelOnMouseClickHandler('idInputPannel')
            </script>

            <!-- overlaypannel for editing sample/block/slide name -->
            <p:overlayPanel id="idInputPannel" onHide="saveNameChange()"
                            dismissable="false" styleClass="histoOverlayPanel"
                            widgetVar="idInputPannel" hideEvent="null" showEvent="null">

                <p:inputText id="idInputPannelInput" widgetVar="idInputPannelInput"
                             styleClass="doNotHideOverlay_js_Class"
                             onkeypress="return closeOverlayPanelOnReturn(event, 'idInputPannel')"
                             disabled="#{!receiptLogView.task.taskStatus.editable}"
                             rendered="#{receiptLogView.selectedRow ne null}"
                             value="#{receiptLogView.selectedRow.IDText}">
                    <p:ajax event="change" process="@this"/>
                </p:inputText>
            </p:overlayPanel>

            <p:remoteCommand
                    actionListener="#{receiptLogView.entityNameChange(receiptLogView.selectedRow, 'log.task.edit.idManuallyAltered', stainingRow.entity.toString())}"
                    name="saveNameChange" update="@(.updateName_js_Class)"/>

        </h:panelGrid>

        <!-- bottom buttons -->
        <h:panelGrid columns="6"
                     style="margin-top:10px; width:auto !important"
                     styleClass="defaultHistoTable">

            <!-- end staning phase -->
            <p:commandButton
                    value="#{msg['body.statiningView.stainingPhaseEnd']}"
                    icon="fa fa-fw fa-image"
                    disabled="#{!receiptLogView.task.taskStatus.editable}"
                    actionListener="#{stainingPhaseExitDialog.initAndPrepareBean(receiptLogView.task)}">
                <p:ajax event="dialogReturn"
                        listener="#{dialogReturnHandler.onDefaultReturn}"
                        update="navigationForm:patientList contentForm:contentPanel headerForm"/>
            </p:commandButton>

            <!-- New sample -->
            <p:commandButton icon="fa fa-fw fa-plus-circle"
                             disabled="#{!receiptLogView.task.taskStatus.editable}"
                             value="#{msg['body.statiningView.newSample']}"
                             actionListener="#{dialog.createSampleDialog.initAndPrepareBean(receiptLogView.task)}">
                <p:ajax event="dialogReturn"
                        listener="#{dialogReturnHandler.onStainingPhaseUpdateReturn}"
                        update="navigationForm:patientList contentForm:contentPanel"/>
            </p:commandButton>

            <!-- Print all slides -->
            <p:commandButton icon="fa fa-fw fa-print"
                             value="#{msg['body.statiningView.printAll']}"
                             actionListener="#{receiptLogView.printAllLabels()}">
            </p:commandButton>

            <!-- select all -->
            <p:commandButton icon="fa fa-fw fa-check-circle"
                             disabled="#{!receiptLogView.task.taskStatus.editable}"
                             update="contentForm:contentPanel"
                             value="#{msg['body.statiningView.chooseAll']}"
                             actionListener="#{receiptLogView.selectListChildren(receiptLogView.rows,true)}"/>

            <h:outputLabel value="#{msg['body.statiningView.choosenElements']}"
                           style="margin-left:20px;"/>

            <h:panelGroup>
                <p:selectOneMenu
                        value="#{receiptLogView.actionOnMany}"
                        disabled="#{!receiptLogView.task.taskStatus.editable}"
                        onchange="PF('performOnMay').jq.click();">

                    <f:selectItems value="#{enumProvider.stainingListActions}"
                                   var="action"
                                   itemLabel="#{msg['enum.stainingListAction.'.concat(action)]}"/>

                </p:selectOneMenu>

                <p:commandButton id="changeZone" widgetVar="performOnMay"
                                 style="display:none;"
                                 update="navigationForm:patientList contentForm:contentPanel headerForm"
                                 actionListener="#{receiptLogView.performActionOnSelectedSlides(receiptLogView.actionOnMany)}">
                </p:commandButton>

            </h:panelGroup>
        </h:panelGrid>
    </p:panel>
</ui:composition>
