<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions">

<h:head>
    <title><h:outputFormat
            value="#{msg[pdfOrganizerDialog.viewOnly ? 'dialog.pdfOrganizer.headline.viewMode' : 'dialog.pdfOrganizer.headline']}"/>
    </title>
    <h:outputStylesheet name="style.css" value="style.css" library="css"/>
    <h:outputStylesheet name="specificStyle.css" value="specificStyle.css"
                        library="css"/>
    <h:outputScript library="scripts" name="commonFunctions.js"/>
</h:head>


<h:body styleClass="histoDialogStyle pdfOrganizer">
    <h:form id="dialogContent">


        <div class="dialogHeader">
            <h:panelGrid style="width:100%;" columns="2"
                         styleClass="defaultHistoTable">
                <h:outputLabel
                        value="#{msg[pdfOrganizerDialog.viewOnly ? 'dialog.pdfOrganizer.headline.viewMode' : 'dialog.pdfOrganizer.headline']}"/>
                <p:commandLink title="#{msg['general.close']}" style="float:right;"
                               onclick="PF('closeBtn').jq.click();return false;">
                    <i class="fa fa-fw fa-times"/>
                </p:commandLink>
            </h:panelGrid>
        </div>

        <div class="dialogContent">

            <h:panelGrid columns="2"
                         styleClass="defaultHistoHiddenTableContainer"
                         columnClasses="columnTop columnWidth300, columnTop"
                         style="width:100%">

                <p:panelGrid styleClass="defaultHistoHiddenTableContainer"
                             id="navigationTable" style="background: black; height: 655px">
                    <p:row>
                        <p:column styleClass="columnTop">
                            <!-- scrolling -->
                            <p:scrollPanel styleClass="histoScrollPanelStyle" id="scrollBody"
                                           style="height:400px;">
                                <!-- navigation tree -->
                                <p:tree value="#{pdfOrganizerDialog.root}" var="node"
                                        styleClass="histoTree" style="width:99%" id="menuTree"
                                        selectionMode="single" draggable="true" droppable="true"
                                        dropRestrict="pdf"
                                        selection="#{pdfOrganizerDialog.selectedNode}">

                                    <p:ajax event="select"
                                            update="dialogContent:content dialogContent:printBtnContainer dialogContent:buttonBtnContainer dialogContent:pdfInfo"
                                            listener="#{pdfOrganizerDialog.displaySelectedContainer()}"/>

                                    <p:ajax event="dragdrop" onstart="setMouseEnterEvents(false)"
                                            listener="#{pdfOrganizerDialog.onDragDrop}"
                                            update="dialogContent:menuTree"
                                            oncomplete="setMouseEnterEvents(true)"/>

                                    <!-- root -->
                                    <p:treeNode expandedIcon="ui-icon-folder-open"
                                                collapsedIcon="ui-icon-folder-collapsed">
                                        <h:outputText value="#{node}"/>
                                    </p:treeNode>

                                    <!-- patient -->
                                    <p:treeNode type="dropAble_Patient" expandedIcon="fa fa-user"
                                                collapsedIcon="fa fa-user">
                                        <h:outputText value="#{node.getPerson().getFullName()}"/>
                                    </p:treeNode>

                                    <!-- Task -->
                                    <p:treeNode type="dropAble_Task"
                                                expandedIcon="ui-icon-folder-open"
                                                collapsedIcon="ui-icon-folder-collapsed">
                                        <h:outputText value="#{node.taskID}"/>
                                    </p:treeNode>

                                    <!-- bio bank -->
                                    <p:treeNode type="dropAble_Biobank" expandedIcon="fa fa-tree"
                                                collapsedIcon="fa fa-tree">
                                        <h:outputText value="Biobank"/>
                                    </p:treeNode>

                                    <!-- pdfs -->
                                    <p:treeNode type="pdf" icon="fa fa-file-pdf-o">
                                        <h:panelGrid columns="1" styleClass="mouseEntryEventElemnt"
                                                     id="bine">
                                            <f:passThroughAttribute name="tvalue" value="#{node.id}"/>

                                            <!-- name -->
                                            <h:outputText value="#{node.name}" id="treeNode">
                                                <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                                <f:attribute name="truncateAt" value="25"/>
                                                <f:attribute name="continuationMark" value="..."/>
                                            </h:outputText>
                                        </h:panelGrid>

                                        <!-- tooltip -->
                                        <pe:tooltip for="bine" onShow="updatef1#{node.id}()"
                                                    mouseTracking="true" myPosition="top left" adjustX="10"
                                                    adjustY="10">

                                            <p:remoteCommand name="updatef1#{node.id}" update="bild2"/>

                                            <h:panelGrid columns="2"
                                                         columnClasses="columnTop, columnLeft" id="bild2"
                                                         style="width:100%"
                                                         styleClass="defaultHistoHiddenTableContainer">
                                                <h:panelGrid columns="2" styleClass="defaultHistoTable">
                                                    <!-- name -->
                                                    <h:outputText
                                                            value="#{msg['dialog.pdfOrganizer.files.name']}"/>
                                                    <h:outputText value="#{node.name}">
                                                        <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                                        <f:attribute name="truncateAt" value="35"/>
                                                        <f:attribute name="continuationMark" value="..."/>
                                                    </h:outputText>

                                                    <!-- created date-->
                                                    <h:outputText
                                                            value="#{msg['component.auditTable.createdOn']}"/>
                                                    <h:outputText value="#{node.audit.createdOn}">
                                                        <f:convertDateTime type="date"
                                                                           pattern="dd.MM.yyyy HH:mm:ss"/>
                                                    </h:outputText>

                                                    <!-- created name-->
                                                    <h:outputText
                                                            value="#{msg['component.auditTable.createdBy']}"/>
                                                    <h:outputText value="#{node.audit.createdBy}">
                                                    </h:outputText>

                                                    <!-- updated date-->
                                                    <h:outputText
                                                            value="#{msg['component.auditTable.updatedOn']}"/>
                                                    <h:outputText
                                                            style="#{node.audit.updatedOn eq 0 ? 'display:none' : ''}"
                                                            value="#{node.audit.updatedOn}">
                                                        <f:convertDateTime type="date"
                                                                           pattern="dd.MM.yyyy HH:mm:ss"/>
                                                    </h:outputText>

                                                    <!-- updated name-->
                                                    <h:outputText
                                                            value="#{msg['component.auditTable.updatedBy']}"/>
                                                    <h:outputText value="#{node.audit.updatedBy}">
                                                    </h:outputText>

                                                    <!-- type -->
                                                    <h:outputText
                                                            value="#{msg['dialog.pdfOrganizer.files.type']}"/>
                                                    <h:outputLabel
                                                            value="#{msg['enum.documentType.'.concat(node.type)]}"/>

                                                    <!-- commentary -->
                                                    <h:outputText
                                                            value="#{msg['dialog.pdfOrganizer.files.commentary']}"/>
                                                    <h:outputText value="#{node.commentary}"
                                                                  title="#{node.commentary}">
                                                        <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                                        <f:attribute name="truncateAt" value="35"/>
                                                        <f:attribute name="continuationMark" value="..."/>
                                                    </h:outputText>
                                                </h:panelGrid>

                                                <!-- preview image -->
                                                <h:panelGrid columns="1" styleClass="defaultHistoTable">
                                                    <p:graphicImage
                                                            value="#{pdfOrganizerDialog.streamContainer.getThumbnail()}"
                                                            style="border: 1px solid black; float: right;"
                                                            width="200px" cache="false" alt="unable to load image"/>
                                                </h:panelGrid>
                                            </h:panelGrid>
                                        </pe:tooltip>

                                        <p:remoteCommand name="updateToolTip#{node.id}"
                                                         actionListener="#{pdfOrganizerDialog.streamContainer.setTooltip(node)}"/>

                                    </p:treeNode>
                                </p:tree>

                                <!-- content menu for navigation tree -->
                                <p:contextMenu for="menuTree" nodeType="pdf">
                                    <p:menuitem
                                            disabled="#{pdfOrganizerDialog.streamContainer.displayPDF.restricted}"
                                            value="#{msg['dialog.pdfOrganizer.tree.menu.edit']}"
                                            onclick="$('#dialogContent\\:editBTN').click();"
                                            icon="fa fa-pencil"/>
                                    <p:menuitem
                                            disabled="#{pdfOrganizerDialog.streamContainer.displayPDF.restricted}"
                                            value="#{msg['dialog.pdfOrganizer.tree.menu.delete']}"
                                            update="@form"
                                            actionListener="#{pdfOrganizerDialog.deletePDFContainer()}"
                                            onclick="$('#dialogContent\\:deleteBTN').click();"
                                            icon="fa fa-trash"/>
                                </p:contextMenu>

                                <h:panelGroup>

                                    <!-- edit button -->
                                    <p:commandButton style="display: none" id="editBTN"
                                                     actionListener="#{pdfOrganizerDialog.editPDFContainer()}">
                                        <p:ajax event="dialogReturn"
                                                listener="#{pdfOrganizerDialog.onDefaultDialogReturn}"
                                                update="dialogContent:menuTree dialogContent:printBtnContainer dialogContent:buttonBtnContainer"/>
                                    </p:commandButton>

                                    <!-- delete button -->
                                    <p:commandButton style="display: none" id="deleteBTN"
                                                     actionListener="#{pdfOrganizerDialog.deletePDFContainer()}">

                                        <p:ajax event="dialogReturn"
                                                listener="#{pdfOrganizerDialog.onDefaultDialogReturn}"
                                                update="@form"/>
                                    </p:commandButton>

                                </h:panelGroup>

                            </p:scrollPanel>

                            <!-- PDF INFO -->
                            <h:panelGroup id="pdfInfo">
                                <h:panelGrid columns="2" styleClass="defaultHistoTable"
                                             style="margin-top:5px;"
                                             rendered="#{pdfOrganizerDialog.streamContainer.displayPDF ne null}">
                                    <!-- name -->
                                    <h:outputText value="#{msg['dialog.pdfOrganizer.files.name']}"/>
                                    <h:outputText
                                            value="#{pdfOrganizerDialog.streamContainer.displayPDF.name}"
                                            title="#{pdfOrganizerDialog.streamContainer.displayPDF.name}">
                                        <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                        <f:attribute name="truncateAt" value="35"/>
                                        <f:attribute name="continuationMark" value="..."/>
                                    </h:outputText>

                                    <!-- created date-->
                                    <h:outputText value="#{msg['component.auditTable.createdOn']}"/>
                                    <h:outputText
                                            value="#{pdfOrganizerDialog.streamContainer.displayPDF.audit.createdOn}">
                                        <f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm:ss"/>
                                    </h:outputText>

                                    <!-- created name-->
                                    <h:outputText value="#{msg['component.auditTable.createdBy']}"/>
                                    <h:outputText
                                            value="#{pdfOrganizerDialog.streamContainer.displayPDF.audit.createdBy}">
                                    </h:outputText>

                                    <!-- updated date-->
                                    <h:outputText value="#{msg['component.auditTable.updatedOn']}"/>
                                    <h:outputText
                                            style="#{pdfOrganizerDialog.streamContainer.displayPDF.audit.updatedOn eq 0 ? 'display:none' : ''}"
                                            value="#{pdfOrganizerDialog.streamContainer.displayPDF.audit.updatedOn}">
                                        <f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm:ss"/>
                                    </h:outputText>

                                    <!-- updated name-->
                                    <h:outputText value="#{msg['component.auditTable.updatedBy']}"/>
                                    <h:outputText
                                            value="#{pdfOrganizerDialog.streamContainer.displayPDF.audit.updatedBy}">
                                    </h:outputText>

                                    <!-- type -->
                                    <h:outputText value="#{msg['dialog.pdfOrganizer.files.type']}"/>
                                    <h:outputLabel
                                            value="#{msg['enum.documentType.'.concat(pdfOrganizerDialog.streamContainer.displayPDF.type)]}"/>

                                    <!-- commentary -->
                                    <h:outputText
                                            value="#{msg['dialog.pdfOrganizer.files.commentary']}"/>

                                    <h:outputText
                                            value="#{pdfOrganizerDialog.streamContainer.displayPDF.commentary}"
                                            title="#{pdfOrganizerDialog.streamContainer.displayPDF.commentary}">
                                        <f:converter converterId="org.histo.ui.TruncateConverter"/>
                                        <f:attribute name="truncateAt" value="35"/>
                                        <f:attribute name="continuationMark" value="..."/>
                                    </h:outputText>
                                </h:panelGrid>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column styleClass="columnBottom">
                            <!-- upload -->
                            <h:outputLabel value="#{msg['dialog.pdfOrganizer.upload']}"/>
                            <p:fileUpload style="width:300px;" update="@form"
                                          fileUploadListener="#{pdfOrganizerDialog.handleFileUpload}"
                                          mode="advanced" auto="true" sizeLimit="10000000"
                                          allowTypes="/(\.|\/)(pdf)$/"/>
                        </p:column>
                    </p:row>
                </p:panelGrid>

                <!-- document viewer -->
                <h:panelGrid id="content"
                             styleClass="defaultHistoHiddenTableContainer noupdate"
                             style="width:calc(100% - 5px)">
                    <pe:documentViewer height="650" style="margin-left:5px;"
                                       class="noupdate"
                                       rendered="#{pdfOrganizerDialog.streamContainer.renderPDF()}"
                                       value="#{pdfOrganizerDialog.streamContainer.getPDF()}"
                                       download="#{pdfOrganizerDialog.streamContainer.displayPDF.name}"/>
                </h:panelGrid>

            </h:panelGrid>

            <!-- blocker for view mode -->
            <p:blockUI block="dialogContent:navigationTable"
                       widgetVar="viewModeBlock"/>

            <script>
                $(document).ready(function () {
                    setMouseEnterEvents(true);
                    commonFunctions.initializeCustomScrollPanel("dialogContent:scrollBody");

                    // disabling pdf selection in view mode
                    if (#{pdfOrganizerDialog.viewOnly}) {
                        PF('viewModeBlock').show();
                    }
                });

                // mouse entry event for tree nodes
                function setMouseEnterEvents() {
                    $(".mouseEntryEventElemnt").each(
                        function (index) {

                            $(this).mouseenter(
                                function () {
                                    eval("updateToolTip"
                                        + $(this).attr("tvalue")
                                        + "()");
                                    //PF('tooltipOverlay').show($(this).attr("id"));
                                });

                            $(this).mouseleave(function () {
                                //PF('tooltipOverlay').hide();
                            });

                        });
                }
            </script>

        </div>

        <div class="buttonContainer">
            <h:panelGrid columns="2">

                <h:panelGrid columns="5" styleClass="left" id="printBtnContainer">

                    <!-- print -->
                    <p:commandButton value="#{msg['dialog.pdfOrganizer.button.print']}"
                                     disabled="#{pdfOrganizerDialog.streamContainer.displayPDF eq null}"
                                     icon="fa fa-print"
                                     actionListener="#{pdfOrganizerDialog.displayPrintNotification(currentUserHandler.printer.print(pdfOrganizerDialog.streamContainer.displayPDF))}"/>

                    <!-- select printer -->
                    <p:selectOneMenu
                            panelStyleClass="searchSelectMenuPanel"
                            converter="#{printService.cupsPrinter.printerTransformer}"
                            value="#{currentUserHandler.printer}" filter="true"
                            filterMatchMode="contains">

                        <f:selectItems value="#{printService.cupsPrinter.printer}"
                                       var="printer" itemLabel="#{printer.name}" itemValue="#{printer}"/>
                    </p:selectOneMenu>

                    <!-- download button -->
                    <p:commandButton value="#{msg['dialog.pdfOrganizer.button.open']}"
                                     icon="fa fa-download" ajax="false"
                                     disabled="#{pdfOrganizerDialog.streamContainer.displayPDF eq null}">
                        <p:fileDownload
                                value="#{pdfOrganizerDialog.streamContainer.getPDF()}"/>
                    </p:commandButton>

                    <!-- edit button -->
                    <p:commandButton value="#{msg['dialog.pdfOrganizer.button.edit']}"
                                     icon="fa fa-pencil" rendered="#{!pdfOrganizerDialog.viewOnly}"
                                     disabled="#{pdfOrganizerDialog.streamContainer.displayPDF eq null or pdfOrganizerDialog.streamContainer.displayPDF.restricted}"
                                     actionListener="#{pdfOrganizerDialog.editPDFContainer(pdfOrganizerDialog.streamContainer.displayPDF)}">

                        <p:ajax event="dialogReturn"
                                listener="#{pdfOrganizerDialog.onDefaultDialogReturn}"
                                update="dialogContent:menuTree dialogContent:printBtnContainer dialogContent:buttonBtnContainer"/>
                    </p:commandButton>

                    <!-- delete button -->
                    <p:commandButton rendered="#{!pdfOrganizerDialog.viewOnly}"
                                     value="#{msg['dialog.pdfOrganizer.button.delete']}"
                                     disabled="#{pdfOrganizerDialog.streamContainer.displayPDF eq null or pdfOrganizerDialog.streamContainer.displayPDF.restricted}"
                                     icon="fa fa-trash"
                                     actionListener="#{pdfOrganizerDialog.deletePDFContainer(pdfOrganizerDialog.streamContainer.displayPDF)}">

                        <p:ajax event="dialogReturn"
                                listener="#{pdfOrganizerDialog.onDefaultDialogReturn}"
                                update="@form"/>
                    </p:commandButton>

                </h:panelGrid>

                <h:panelGrid columns="3" styleClass="right" id="buttonBtnContainer">

                    <!-- upload button -->
                    <p:commandButton rendered="#{!pdfOrganizerDialog.viewOnly}"
                                     value="#{msg['dialog.pdfOrganizer.button.upload']}"
                                     icon="fa fa-cloud-upload"
                                     actionListener="#{dialog.uploadDialog.initAndPrepareBean(dialog.pdfOrganizer.dataLists,dialog.pdfOrganizer.patient).initializeUploadFileTypes()}">

                        <p:ajax event="dialogReturn"
                                listener="#{pdfOrganizerDialog.onDefaultDialogReturn}"
                                update="@form"/>
                    </p:commandButton>

                    <!-- edit button -->
                    <p:commandButton
                            value="#{msg['dialog.pdfOrganizer.button.select']}"
                            icon="fa fa-pencil"
                            rendered="#{pdfOrganizerDialog.enablePDFSelection and !pdfOrganizerDialog.viewOnly}"
                            disabled="#{pdfOrganizerDialog.streamContainer.displayPDF eq null}"
                            actionListener="#{pdfOrganizerDialog.selectAndHide()}">

                    </p:commandButton>

                    <!-- Close button -->
                    <p:commandButton value="#{msg['general.close']}" id="closeBtn" widgetVar="closeBtn"
                                     icon="fa fa-times-circle"
                                     actionListener="#{pdfOrganizerDialog.hideDialog()}"/>

                </h:panelGrid>
            </h:panelGrid>
        </div>


    </h:form>
</h:body>
</html>
