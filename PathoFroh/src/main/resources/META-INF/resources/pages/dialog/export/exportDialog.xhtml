<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title><h:outputFormat
            value="#{msg['dialog.diagnosisPhaseExit.headline']}"/></title>
    <h:outputStylesheet name="style.css" value="style.css" library="css"/>
    <h:outputStylesheet name="specificStyle.css" value="specificStyle.css"
                        library="css"/>
    <h:outputScript library="scripts" name="commonFunctions.js"/>
</h:head>

<h:body styleClass="histoDialogStyle">

    <h:form id="dialogContent">

        <p:remoteCommand name="loadContent" action="#{exportTasksDialog.update()}"
                         process="@this" autoRun="true"
                         partialSubmit="true"/>

        <div class="dialogHeader">
            <h:panelGrid style="width:100%;" columns="2">
                <h:outputLabel value="#{msg['dialog.diagnosisPhaseExit.headline']}"/>
                <p:commandLink title="#{msg['general.close']}" style="float:right;" process="@this"
                               onclick="$('#dialogContent\\:closeBtn').click();return false;">
                    <i class="fa fa-fw fa-times"/>
                </p:commandLink>
            </h:panelGrid>
        </div>

        <div class="dialogContent">
            <p:outputPanel deferred="true" id="dataContainer" autoUpdate="false" style="height: 520px">
                <h:panelGrid styleClass="defaultHistoTable">
                    <h:outputFormat value="Gefundene AuftrÃ¤ge {0}">
                        <f:param
                                value="#{exportTasksDialog.tasks.size()}"/>
                    </h:outputFormat>
                </h:panelGrid>

                <p:dataTable var="task" scrollable="true" scrollHeight="450" id="tasks" lazy="true"
                             value="#{exportTasksDialog.tasks}" styleClass="defaultHistoDataTable"
                             selection="#{exportTasksDialog.selectedTasks}" rowKey="#{task.id}">


                    <p:column selectionMode="multiple"
                              style="width:16px;text-align:center"/>

                    <p:column headerText="Id" sortBy="#{task.taskID}">
                        <h:outputText value="#{task.taskID}"/>
                    </p:column>

                    <p:column headerText="Name">
                        <h:outputText value="#{task.parent.person.lastName}"/>
                    </p:column>

                    <p:column headerText="Vorname">
                        <h:outputText value="#{task.parent.person.firstName}"/>
                    </p:column>

                    <p:column headerText="PIZ">
                        <h:outputText value="#{task.parent.piz}"/>
                    </p:column>

                    <p:column headerText="Geburztag">
                        <h:outputText value="#{task.parent.person.birthday}">
                            <f:convertDateTime type="localDate" pattern="MM.dd.yyyy" timeZone="Europe/Berlin"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Datum">
                        <h:outputText value="#{task.receiptDate}">
                            <f:convertDateTime type="localDate" pattern="MM.dd.yyyy" timeZone="Europe/Berlin"/>
                        </h:outputText>
                    </p:column>


                    <p:column headerText="Diagnoses">
                        <p:repeat value="#{task.diagnosisRevisions}" var="revision">
                            <p:repeat value="#{revision.diagnoses}" var="diagnosis" varStatus="varIndex">
                                <h:outputText value="#{diagnosis.diagnosis} #{!varIndex.last ? ';' : '' }"/>
                            </p:repeat>
                        </p:repeat>
                    </p:column>

                    <p:ajax event="rowSelect" process="@this"/>
                </p:dataTable>


            </p:outputPanel>
        </div>

        <div class="buttonContainer">
            <h:panelGrid columns="2">

                <h:panelGrid columns="1" styleClass="left">
                    <h:panelGroup>
                        <p:commandButton value="Export"
                                         onclick="$('#dialogContent\\:exportLink').click();return false;">
                        </p:commandButton>
                        <h:commandLink style="display: none" id="exportLink">
                            <p:dataExporter type="xls" target="tasks" fileName="export" selectionOnly="true"/>
                        </h:commandLink>
                    </h:panelGroup>
                </h:panelGrid>

                <h:panelGrid columns="2" styleClass="right" id="buttonContainer">
                    <p:commandButton value="#{msg['general.save']}" update="@form"
                                     process="@form" icon="fa fa-fw fa-check-circle-o">
                        <f:actionListener
                                binding="#{exportTasksDialog.hideDialog()}"/>
                    </p:commandButton>

                    <p:commandButton value="#{msg['general.abort']}" immediate="true" process="@this"
                                     partialSubmit="true" icon="fa fa-fw fa-times-circle" id="closeBtn"
                                     actionListener="#{exportTasksDialog.hideDialog()}"/>
                </h:panelGrid>
            </h:panelGrid>
        </div>

    </h:form>
</h:body>
</html>
